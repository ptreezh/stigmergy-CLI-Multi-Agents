#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ™ºèƒ½ä½“åä½œç³»ç»Ÿ - å…¨å±€éƒ¨ç½²è„šæœ¬
ç”¨äºå®‰è£…å’Œé…ç½®CLIå·¥å…·çš„åä½œèƒ½åŠ›
"""

import os
import sys
import json
import platform
import subprocess
from pathlib import Path
from datetime import datetime


def main():
    """å…¨å±€éƒ¨ç½²å…¥å£"""
    print("ğŸš€ æ™ºèƒ½ä½“åä½œç³»ç»Ÿ - å…¨å±€éƒ¨ç½²å‘å¯¼")
    print("=" * 50)
    
    # 1. æ‰«æç³»ç»Ÿä¸­çš„CLIå·¥å…·
    print("ğŸ” æ­£åœ¨æ‰«æç³»ç»Ÿä¸­çš„å¯ç”¨CLIå·¥å…·...")
    
    system = platform.system().lower()
    known_tools = [
        "claude", "gemini", "kimi", "qwen", "ollama", 
        "codebuddy", "qodercli", "iflow", "copilot"
    ]
    
    available_tools = {}
    for tool in known_tools:
        try:
            if system == "windows":
                result = subprocess.run(["where", tool], 
                                      capture_output=True, text=True, timeout=5)
            else:
                result = subprocess.run(["which", tool], 
                                      capture_output=True, text=True, timeout=5)
            
            if result.returncode == 0:
                available_tools[tool] = result.stdout.strip().split('\n')[0] if result.stdout.strip() else tool
                print(f"   âœ… {tool}: å¯ç”¨")
            else:
                print(f"   âŒ {tool}: æœªæ‰¾åˆ°")
        except:
            print(f"   âŒ {tool}: æœªæ‰¾åˆ°")
    
    if not available_tools:
        print("\nâš ï¸  æœªæ‰¾åˆ°ä»»ä½•æ”¯æŒçš„CLIå·¥å…·")
        print("ğŸ’¡  è¯·å…ˆå®‰è£…è‡³å°‘ä¸€ä¸ªæ”¯æŒçš„AI CLIå·¥å…·åé‡è¯•")
        print("   æ”¯æŒçš„å·¥å…·: Claude, Gemini, Kimi, Qwen, Ollama, CodeBuddyç­‰")
        return False

    print(f"\nğŸ“‹ å…±å‘ç° {len(available_tools)} ä¸ªå¯ç”¨å·¥å…·")
    print("ğŸ’¡ åä½œç³»ç»Ÿå°†ä¸ºè¿™äº›å·¥å…·æ·»åŠ å†…éƒ¨è‡ªç„¶è¯­è¨€äº¤äº’èƒ½åŠ›")
    
    # 2. åˆ›å»ºé¡¹ç›®èƒŒæ™¯æ¨¡æ¿
    print("\nğŸ“ å‡†å¤‡é¡¹ç›®åä½œæ¨¡æ¿...")
    
    # åˆ›å»ºé»˜è®¤çš„é¡¹ç›®è§„èŒƒ
    if not Path("PROJECT_SPEC.json").exists():
        project_spec = {
            "project_name": "New Collaboration Project",
            "created_at": datetime.now().isoformat(),
            "status": "active", 
            "tasks": {},
            "collaboration_history": [],
            "current_state": {
                "active_task": None,
                "completed_tasks": [],
                "pending_tasks": [],
                "next_scheduled_task": None
            },
            "collaboration_rules": {
                "communication_protocol": "stigmergy_based",
                "task_distribution": "autonomous",
                "auto_assign_keywords": [".*"]
            }
        }
        
        with open("PROJECT_SPEC.json", 'w', encoding='utf-8') as f:
            json.dump(project_spec, f, ensure_ascii=False, indent=2)
        
        print("   âœ… åˆ›å»ºPROJECT_SPEC.jsonæ¨¡æ¿")
    else:
        print("   â– PROJECT_SPEC.jsonå·²å­˜åœ¨")
    
    # åˆ›å»ºé¡¹ç›®å®ªæ³•
    if not Path("PROJECT_CONSTITUTION.md").exists():
        constitution_content = """# é¡¹ç›®åä½œå®ªæ³•

## åä½œåŸºæœ¬åŸåˆ™

### 1. åŸºäºèƒŒæ™¯çš„é—´æ¥ååŒï¼ˆStigmergyï¼‰
- æ‰€æœ‰åä½œé€šè¿‡ PROJECT_SPEC.json æ–‡ä»¶è¿›è¡Œåè°ƒ
- æ™ºèƒ½ä½“åŸºäºèƒŒæ™¯çŠ¶æ€è‡ªä¸»å†³ç­–ï¼Œæ— ä¸­å¤®åè°ƒå™¨
- é€šè¿‡ç¯å¢ƒçº¿ç´¢å®ç°é—´æ¥é€šä¿¡å’Œåä½œ

### 2. ä»»åŠ¡ç®¡ç†åŸåˆ™
- æ™ºèƒ½ä½“å¯è®¤é¢†åˆ†é…ç»™è‡ªå·±çš„ä»»åŠ¡
- æ™ºèƒ½ä½“å¯è®¤é¢†ä¸å…¶èƒ½åŠ›åŒ¹é…çš„æœªåˆ†é…ä»»åŠ¡
- ä»»åŠ¡çŠ¶æ€å®æ—¶æ›´æ–°è‡³å…±äº«èƒŒæ™¯æ–‡ä»¶

### 3. è‡ªç„¶è¯­è¨€åä½œåè®®
- `è®©<å·¥å…·å>å¸®æˆ‘<ä»»åŠ¡>` - å§”æ´¾ä»»åŠ¡ç»™æŒ‡å®šå·¥å…·
- `ç”¨<å·¥å…·å><ä»»åŠ¡>` - ç›´æ¥è·¯ç”±åˆ°æŒ‡å®šå·¥å…·
- `è¯·<å·¥å…·å><ä»»åŠ¡>` - è¯·æ±‚æŒ‡å®šå·¥å…·ååŠ©

### 4. çŠ¶æ€ç®¡ç†åŸåˆ™
- ä»»åŠ¡çŠ¶æ€åŒ…æ‹¬: pending, in_progress, completed, failed
- æ‰€æœ‰åä½œæ´»åŠ¨è®°å½•åœ¨åä½œå†å²ä¸­
- çŠ¶æ€å˜æ›´é€šè¿‡å…±äº«èƒŒæ™¯æ–‡ä»¶åŒæ­¥
"""
        with open("PROJECT_CONSTITUTION.md", 'w', encoding='utf-8') as f:
            f.write(constitution_content)
        
        print("   âœ… åˆ›å»ºPROJECT_CONSTITUTION.mdæ¨¡æ¿")
    else:
        print("   â– PROJECT_CONSTITUTION.mdå·²å­˜åœ¨")
    
    print("\nğŸ¯ éƒ¨ç½²å®Œæˆï¼")
    print("=" * 50)
    print("ğŸ’¡ ç°åœ¨æ‚¨å¯ä»¥ç›´æ¥åœ¨ç°æœ‰CLIå·¥å…·ä¸­ä½¿ç”¨åä½œåŠŸèƒ½ï¼š")
    print("   claude \"è®©geminiå¸®æˆ‘ç¿»è¯‘\"")
    print("   gemini \"è¯·codebuddyä¼˜åŒ–è¿™æ®µä»£ç \"")
    print("   qwen \"ç”¨claudeåˆ†æç®—æ³•å¤æ‚åº¦\"")
    print("\nğŸ”„ å·¥ä½œåŸç†ï¼š")
    print("   - åœ¨é¡¹ç›®ç›®å½•è‡ªåŠ¨åˆ›å»ºåä½œèƒŒæ™¯æ–‡ä»¶")
    print("   - é€šè¿‡èƒŒæ™¯æ–‡ä»¶å®ç°å¤šæ™ºèƒ½ä½“é—´æ¥ååŒ")
    print("   - æ— éœ€æ”¹å˜åŸæœ‰ä½¿ç”¨ä¹ æƒ¯")
    print("\nğŸŒ è®¿é—® http://www.socienceAI.com äº†è§£æ›´å¤šä¿¡æ¯")
    print("ğŸ”— è¿œç¨‹ä»“åº“: https://github.com/ptreezh/stigmergy-CLI-Multi-Agents")
    
    return True


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)