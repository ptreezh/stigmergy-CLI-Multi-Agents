#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ™ºèƒ½ä½“åä½œç³»ç»Ÿ - éƒ¨ç½²éªŒè¯è„šæœ¬
éªŒè¯æ‰€æœ‰ç»„ä»¶æ˜¯å¦æ­£ç¡®éƒ¨ç½²
"""

import os
import sys
import subprocess
import json
from pathlib import Path


def validate_deployment():
    """éªŒè¯éƒ¨ç½²çŠ¶æ€"""
    print("ğŸ” æ™ºèƒ½ä½“åä½œç³»ç»Ÿéƒ¨ç½²éªŒè¯")
    print("=" * 60)
    
    success_count = 0
    total_checks = 0
    
    # 1. éªŒè¯æ ¸å¿ƒæºä»£ç å®Œæ•´
    print("\nğŸ“‹ æ£€æŸ¥æ ¸å¿ƒç»„ä»¶...")
    total_checks += 1
    core_files = [
        "src/cli_collaboration_agent.py",
        "src/atomic_collaboration_handler.py", 
        "src/universal_cli_setup.py"
    ]
    
    all_present = True
    for file in core_files:
        if os.path.exists(file):
            print(f"   âœ… {file}: å­˜åœ¨")
        else:
            print(f"   âŒ {file}: ç¼ºå¤±")
            all_present = False
    
    if all_present:
        success_count += 1
        print("   âœ… æ ¸å¿ƒç»„ä»¶æ£€æŸ¥é€šè¿‡")
    else:
        print("   âŒ æ ¸å¿ƒç»„ä»¶æ£€æŸ¥å¤±è´¥")
    
    # 2. éªŒè¯åä½œèƒŒæ™¯æ¨¡æ¿
    print("\nğŸ“ æ£€æŸ¥åä½œèƒŒæ™¯æ¨¡æ¿...")
    total_checks += 1
    template_files = [
        "PROJECT_CONSTITUTION.md",
        "PROJECT_SPEC.json.template",  # å¦‚æœæ˜¯æ¨¡æ¿æ–‡ä»¶
        "TASKS.md",
        "COLLABORATION_LOG.md"
    ]
    
    templates_present = 0
    for file in template_files:
        if os.path.exists(file):
            print(f"   âœ… {file}: å­˜åœ¨")
            templates_present += 1
        else:
            print(f"   âš ï¸  {file}: ç¼ºå¤±")
    
    if templates_present >= 2:  # è‡³å°‘ä¸»è¦æ¨¡æ¿å­˜åœ¨
        success_count += 1
        print("   âœ… åä½œèƒŒæ™¯æ¨¡æ¿åŸºæœ¬å®Œæ•´")
    else:
        print("   âŒ åä½œèƒŒæ™¯æ¨¡æ¿ä¸å®Œæ•´")
    
    # 3. éªŒè¯ç½‘ç«™å†…å®¹
    print("\nğŸŒ æ£€æŸ¥ç½‘ç«™å†…å®¹...")
    total_checks += 1
    website_files = [
        "website/index.html",
        "website/en/index.html", 
        "website/zh/index.html",
        "website/css/style.css",
        "website/js/main.js"
    ]
    
    website_present = 0
    for file in website_files:
        if os.path.exists(file):
            print(f"   âœ… {file}: å­˜åœ¨")
            website_present += 1
        else:
            print(f"   âŒ {file}: ç¼ºå¤±")
    
    if website_present >= 5:  # æ‰€æœ‰ç½‘ç«™æ–‡ä»¶éƒ½åº”å­˜åœ¨
        success_count += 1
        print("   âœ… ç½‘ç«™å†…å®¹æ£€æŸ¥é€šè¿‡")
    else:
        print("   âŒ ç½‘ç«™å†…å®¹æ£€æŸ¥å¤±è´¥")
    
    # 4. éªŒè¯éƒ¨ç½²è„šæœ¬åŠŸèƒ½
    print("\nğŸ”§ æ£€æŸ¥éƒ¨ç½²è„šæœ¬...")
    total_checks += 1
    deploy_scripts = [
        "deploy.py",
        "auto_integrate.sh"
    ]
    
    scripts_present = 0
    for script in deploy_scripts:
        if os.path.exists(script):
            print(f"   âœ… {script}: å­˜åœ¨")
            scripts_present += 1
        else:
            print(f"   âš ï¸  {script}: ç¼ºå¤±")
    
    if scripts_present >= 1:
        success_count += 1
        print("   âœ… éƒ¨ç½²è„šæœ¬å­˜åœ¨")
    else:
        print("   âŒ éƒ¨ç½²è„šæœ¬ç¼ºå¤±")
    
    # 5. éªŒè¯æ–‡æ¡£
    print("\nğŸ“š æ£€æŸ¥æ–‡æ¡£...")
    total_checks += 1
    doc_files = [
        "README.md",
        "LICENSE",
        "requirements.txt",
        "CONTRIBUTING.md"
    ]
    
    docs_present = 0
    for doc in doc_files:
        if os.path.exists(doc):
            print(f"   âœ… {doc}: å­˜åœ¨")
            docs_present += 1
        else:
            print(f"   âŒ {doc}: ç¼ºå¤±")
    
    if docs_present >= 3:
        success_count += 1
        print("   âœ… æ ¸å¿ƒæ–‡æ¡£æ£€æŸ¥é€šè¿‡")
    else:
        print("   âŒ æ ¸å¿ƒæ–‡æ¡£æ£€æŸ¥å¤±è´¥")
    
    # 6. éªŒè¯æµ‹è¯•å¥—ä»¶
    print("\nğŸ§ª æ£€æŸ¥æµ‹è¯•å¥—ä»¶...")
    total_checks += 1
    test_files = [
        "tests/test_unit.py",
        "tests/test_integration.py"
    ]
    
    tests_present = 0
    for test_file in test_files:
        if os.path.exists(test_file):
            print(f"   âœ… {test_file}: å­˜åœ¨")
            tests_present += 1
        else:
            print(f"   âŒ {test_file}: ç¼ºå¤±")
    
    if tests_present >= 2:
        success_count += 1
        print("   âœ… æµ‹è¯•å¥—ä»¶æ£€æŸ¥é€šè¿‡")
    else:
        print("   âŒ æµ‹è¯•å¥—ä»¶ä¸å®Œæ•´")
    
    print(f"\nğŸ“Š éƒ¨ç½²éªŒè¯ç»“æœ: {success_count}/{total_checks} é¡¹é€šè¿‡")
    
    if success_count == total_checks:
        print("\nâœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼ç³»ç»Ÿéƒ¨ç½²å®Œæ•´ã€‚")
        print("ğŸ¯ ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨æ™ºèƒ½ä½“åä½œç³»ç»Ÿè¿›è¡ŒåŸºäºèƒŒæ™¯çš„é—´æ¥ååŒï¼ˆStigmergyï¼‰")
        print("ğŸ”— é¡¹ç›®åœ°å€: https://github.com/ptreezh/stigmergy-CLI-Multi-Agents")
        return True
    else:
        print(f"\nâš ï¸  {total_checks - success_count} é¡¹éªŒè¯æœªé€šè¿‡")
        return False


def validate_urls():
    """éªŒè¯URLé“¾æ¥æ˜¯å¦å·²æ›´æ–°"""
    print("\nğŸ”— éªŒè¯è¿œç¨‹ä»“åº“URL...")
    
    # æ£€æŸ¥ä¸»è¦æ–‡ä»¶ä¸­çš„URL
    files_to_check = [
        "README.md",
        "website/index.html",
        "website/en/index.html",
        "docs/PROJECT_STRUCTURE.md"
    ]
    
    correct_url = "https://github.com/ptreezh/stigmergy-CLI-Multi-Agents"
    all_correct = True
    
    for file_path in files_to_check:
        if os.path.exists(file_path):
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            if correct_url in content:
                print(f"   âœ… {file_path}: åŒ…å«æ­£ç¡®URL")
            else:
                print(f"   âš ï¸  {file_path}: å¯èƒ½ç¼ºå°‘æ­£ç¡®URL")
                # æ£€æŸ¥æ˜¯å¦æœ‰æ—§URL
                if "your-username" in content or "smart-cli-router" in content:
                    print(f"      - å¯èƒ½ä»åŒ…å«æ—§URLå¼•ç”¨")
                all_correct = False
    
    if all_correct:
        print("   âœ… æ‰€æœ‰URLé“¾æ¥å·²æ­£ç¡®æ›´æ–°")
    else:
        print("   âš ï¸  éƒ¨åˆ†URLé“¾æ¥å¯èƒ½éœ€è¦æ›´æ–°")
    
    return all_correct


if __name__ == "__main__":
    success = validate_deployment()
    urls_correct = validate_urls()
    
    print("\n" + "=" * 60)
    print("ğŸ éƒ¨ç½²éªŒè¯æ‘˜è¦")
    print("=" * 60)
    
    if success:
        if urls_correct:
            print("ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼")
            print("   âœ… ç³»ç»Ÿç»„ä»¶å®Œæ•´")
            print("   âœ… URLé“¾æ¥æ­£ç¡®")
            print("   âœ… å‡†å¤‡å°±ç»ª - å¯ä»¥ä½¿ç”¨Stigmergyåä½œæœºåˆ¶")
        else:
            print("âš ï¸  éƒ¨ç½²åŸºæœ¬å®Œæ•´ï¼Œä½†URLé“¾æ¥éœ€è¦æ£€æŸ¥")
    else:
        print("âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¼ºå¤±çš„ç»„ä»¶")
    
    sys.exit(0 if success and urls_correct else 1)