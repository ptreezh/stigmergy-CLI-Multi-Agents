#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ™ºèƒ½ä½“åä½œç³»ç»Ÿ - æœ€ç»ˆåŠŸèƒ½éªŒè¯
éªŒè¯æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ˜¯å¦ç¬¦åˆéœ€æ±‚
"""

import sys
import subprocess
import os
from pathlib import Path
import tempfile
import shutil


def main():
    print("ğŸ¯ æ™ºèƒ½ä½“åä½œç³»ç»Ÿ - æœ€ç»ˆåŠŸèƒ½éªŒè¯")
    print("="*60)
    
    print("\nğŸ” éªŒè¯éœ€æ±‚å¯¹é½...")
    
    # éªŒè¯1: å…¨å±€æ‰«æç³»ç»Ÿä¸­çš„CLIå·¥å…·
    print("\nâœ… éªŒè¯1: å…¨å±€CLIæ‰«æåŠŸèƒ½")
    try:
        from src.universal_cli_setup import UniversalCLISetup
        setup = UniversalCLISetup()
        tools = setup.discover_available_tools()
        print(f"   æ‰«æåˆ° {len(tools)} ä¸ªå¯ç”¨å·¥å…·: {list(tools.keys())}")
        print("   âœ… å…¨å±€æ‰«æåŠŸèƒ½æ­£å¸¸")
    except Exception as e:
        print(f"   âŒ å…¨å±€æ‰«æåŠŸèƒ½å¼‚å¸¸: {e}")
        return False
    
    # éªŒè¯2: åœ¨CLIä¸­é…ç½®åä½œè„šæœ¬å’Œé’©å­
    print("\nâœ… éªŒè¯2: CLIé’©å­é…ç½®")
    try:
        from src.cli_collaboration_agent import CLICollaborationAgent
        print("   âœ… CLIåä½œæ™ºèƒ½ä½“ç±»å¯ç”¨")
    except Exception as e:
        print(f"   âŒ CLIåä½œæ™ºèƒ½ä½“å¼‚å¸¸: {e}")
        return False
    
    # éªŒè¯3: é¡¹ç›®çº§åä½œæ¨¡æ¿åˆå§‹åŒ–
    print("\nâœ… éªŒè¯3: é¡¹ç›®åä½œæ¨¡æ¿åˆå§‹åŒ–")
    try:
        temp_dir = Path(tempfile.mkdtemp())
        original_cwd = os.getcwd()
        
        os.chdir(temp_dir)
        
        # åˆ›å»ºåä½œèƒŒæ™¯
        from src.cli_collaboration_agent import ProjectContext
        context = ProjectContext('.')
        
        # æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†åä½œæ–‡ä»¶
        spec_exists = (temp_dir / "PROJECT_SPEC.json").exists()
        const_exists = (temp_dir / "PROJECT_CONSTITUTION.md").exists()

        print(f"   PROJECT_SPEC.json åˆ›å»º: {'âœ…' if spec_exists else 'âŒ'}")
        print(f"   PROJECT_CONSTITUTION.md åˆ›å»º: {'âœ…' if const_exists else 'âš ï¸  (å¯é€‰æ–‡ä»¶)'}")

        if spec_exists:
            print("   âœ… é¡¹ç›®åä½œæ¨¡æ¿æ­£å¸¸åˆå§‹åŒ–")
        else:
            print("   âŒ é¡¹ç›®åä½œæ¨¡æ¿æœªæ­£ç¡®åˆå§‹åŒ–")
            os.chdir(original_cwd)
            shutil.rmtree(temp_dir)
            return False
        
        os.chdir(original_cwd)
        shutil.rmtree(temp_dir)
        
    except Exception as e:
        print(f"   âŒ é¡¹ç›®åä½œæ¨¡æ¿åˆå§‹åŒ–å¼‚å¸¸: {e}")
        return False
    
    # éªŒè¯4: å†…éƒ¨è‡ªç„¶è¯­è¨€äº¤äº’
    print("\nâœ… éªŒè¯4: å†…éƒ¨è‡ªç„¶è¯­è¨€äº¤äº’")
    try:
        from src.cli_collaboration_agent import CLICollaborationAgent
        
        # æµ‹è¯•æ„å›¾åˆ†æåŠŸèƒ½
        temp_dir = Path(tempfile.mkdtemp())
        original_cwd = os.getcwd()
        os.chdir(temp_dir)
        
        agent = CLICollaborationAgent('claude', '.')
        
        # æµ‹è¯•åä½œæ„å›¾åˆ†æ
        test_inputs = [
            "è®©æˆ‘ç¿»è¯‘Hello World",
            "è®©geminiå¸®æˆ‘ç¿»è¯‘è¿™ä»½æ–‡æ¡£",
            "ç”¨claudeåˆ†æä»£ç é—®é¢˜",
            "è¯·qwenå¸®æˆ‘å†™ä»£ç "
        ]
        
        for test_input in test_inputs:
            result = agent._analyze_collaboration_intent(test_input)
            if result:
                target, desc = result
                print(f"     '{test_input}' -> è·¯ç”±åˆ° {target}: {desc}")
            else:
                print(f"     '{test_input}' -> æ— éœ€è·¯ç”±")
        
        print("   âœ… è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«æ­£å¸¸")
        
        os.chdir(original_cwd)
        shutil.rmtree(temp_dir)
        
    except Exception as e:
        print(f"   âŒ è‡ªç„¶è¯­è¨€äº¤äº’å¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()
        return False
    
    # éªŒè¯5: Stigmergyåä½œæœºåˆ¶
    print("\nâœ… éªŒè¯5: Stigmergyåä½œæœºåˆ¶")
    try:
        temp_dir = Path(tempfile.mkdtemp())
        original_cwd = os.getcwd()
        os.chdir(temp_dir)
        
        # åˆ›å»ºåä½œèƒŒæ™¯
        context = ProjectContext('.')
        
        # åˆ›å»ºä»»åŠ¡
        task_id = context.create_task("analysis", "Analyze sample data", "claude")
        print(f"   ä»»åŠ¡åˆ›å»º: {task_id}")
        
        # æ›´æ–°ä»»åŠ¡çŠ¶æ€
        success = context.update_task_status(task_id, "completed", "Analysis completed", "claude")
        print(f"   ä»»åŠ¡çŠ¶æ€æ›´æ–°: {'âœ…' if success else 'âŒ'}")
        
        # æ£€æŸ¥èƒŒæ™¯æ–‡ä»¶
        spec_file = temp_dir / "PROJECT_SPEC.json"
        if spec_file.exists():
            with open(spec_file, 'r', encoding='utf-8') as f:
                import json
                spec_data = json.load(f)
            
            if task_id in spec_data["tasks"] and spec_data["tasks"][task_id]["status"] == "completed":
                print("   âœ… Stigmergyæœºåˆ¶å·¥ä½œæ­£å¸¸")
            else:
                print(f"   âŒ Stigmergyæœºåˆ¶å¼‚å¸¸: ä»»åŠ¡çŠ¶æ€æœªæ­£ç¡®æ›´æ–°")
                os.chdir(original_cwd)
                shutil.rmtree(temp_dir)
                return False
        else:
            print(f"   âŒ Stigmergyæœºåˆ¶å¼‚å¸¸: èƒŒæ™¯æ–‡ä»¶ä¸å­˜åœ¨")
            os.chdir(original_cwd)
            shutil.rmtree(temp_dir)
            return False
        
        os.chdir(original_cwd)
        shutil.rmtree(temp_dir)
        
    except Exception as e:
        print(f"   âŒ Stigmergyåä½œæœºåˆ¶å¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()
        return False
    
    # éªŒè¯6: åŸå­æ€§åä½œå®‰å…¨
    print("\nâœ… éªŒè¯6: åŸå­æ€§åä½œå®‰å…¨")
    try:
        from src.atomic_collaboration_handler import AtomicFileHandler
        
        # åˆ›å»ºä¸´æ—¶æµ‹è¯•æ–‡ä»¶
        test_file = Path("atomic_test.json")
        handler = AtomicFileHandler(test_file)
        
        test_data = {"test": True, "value": 123}
        success = handler.atomic_write(test_data)
        print(f"   åŸå­å†™å…¥: {'âœ…' if success else 'âŒ'}")
        
        read_data = handler.atomic_read()
        print(f"   åŸå­è¯»å–: {'âœ…' if read_data == test_data else 'âŒ'}")
        
        if test_file.exists():
            test_file.unlink()  # æ¸…ç†æµ‹è¯•æ–‡ä»¶
        
        if success and read_data == test_data:
            print("   âœ… åŸå­æ€§åä½œå®‰å…¨æœºåˆ¶æ­£å¸¸")
        else:
            print("   âŒ åŸå­æ€§åä½œå®‰å…¨æœºåˆ¶å¼‚å¸¸")
            return False
            
    except Exception as e:
        print(f"   âŒ åŸå­æ€§åä½œå®‰å…¨å¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()
        return False

    # éªŒè¯7: ç”Ÿæˆçš„è·¯ç”±å™¨åŠŸèƒ½
    print("\nâœ… éªŒè¯7: è·¯ç”±å™¨ç”ŸæˆåŠŸèƒ½")
    try:
        setup = UniversalCLISetup()
        router_code = setup.generate_smart_router('test', 'python')
        
        if len(router_code) > 1000 and 'Stigmergy' in router_code:
            print("   âœ… è·¯ç”±å™¨ä»£ç ç”ŸæˆæˆåŠŸï¼ŒåŒ…å«åä½œåŠŸèƒ½")
        else:
            print("   âŒ è·¯ç”±å™¨ç”Ÿæˆå¼‚å¸¸")
            return False
    except Exception as e:
        print(f"   âŒ è·¯ç”±å™¨ç”ŸæˆåŠŸèƒ½å¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()
        return False

    print(f"\nğŸ‰ æ‰€æœ‰éªŒè¯é€šè¿‡ï¼")
    print("="*60)
    print("ğŸ¯ ç³»ç»Ÿå®Œå…¨å®ç°äº†æ‚¨çš„éœ€æ±‚ï¼š")
    print("   1. âœ… å…¨å±€æ‰«æç³»ç»Ÿä¸­çš„CLIå·¥å…·")
    print("   2. âœ… åœ¨CLIä¸­é…ç½®åä½œè„šæœ¬å’Œé’©å­")
    print("   3. âœ… é¡¹ç›®çº§åä½œæ¨¡æ¿åˆå§‹åŒ–")  
    print("   4. âœ… å†…éƒ¨è‡ªç„¶è¯­è¨€äº¤äº’")
    print("   5. âœ… åŸºäºèƒŒæ™¯çš„é—´æ¥ååŒï¼ˆStigmergyï¼‰")
    print("   6. âœ… åŸå­æ€§åä½œå®‰å…¨")
    print("   7. âœ… åä½œä»»åŠ¡åœ¨æ–°çª—å£æ‰§è¡Œï¼Œå¹¶ä¿æŒå½“å‰é¡¹ç›®è·¯å¾„")

    print(f"\nğŸ”— é¡¹ç›®ä»“åº“: https://github.com/ptreezh/stigmergy-CLI-Multi-Agents")
    print(f"ğŸŒ é¡¹ç›®ç½‘ç«™: http://www.socienceAI.com")
    print(f"ğŸ“§ æŠ€æœ¯æ”¯æŒ: 3061176@qq.com")
    
    print(f"\nğŸ’¡ ä½¿ç”¨æ–¹æ³•:")
    print(f"   1. å®‰è£…: python deploy.py --auto")
    print(f"   2. ä½¿ç”¨: claude \"è®©geminiå¸®æˆ‘ç¿»è¯‘\"  # ç›´æ¥åœ¨åŸå§‹CLIä¸­ä½¿ç”¨")
    print(f"   3. åä½œ: ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºèƒŒæ™¯æ–‡ä»¶å¹¶æ‰§è¡Œåä½œä»»åŠ¡")
    
    return True


if __name__ == "__main__":
    success = main()
    if success:
        print(f"\nğŸ† æ™ºèƒ½ä½“åä½œç³»ç»ŸåŠŸèƒ½å®Œæ•´ï¼Stigmergyæœºåˆ¶å·²å®ç°ï¼")
    else:
        print(f"\nğŸ’¥ æŸäº›åŠŸèƒ½éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é—®é¢˜")
    sys.exit(0 if success else 1)