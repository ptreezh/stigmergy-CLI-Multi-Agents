# DNASPEC Cache Manager 使用指南

## 概述

DNASPEC Cache Manager 是一个智能文件缓存管理系统，用于管理 AI 生成的文件，通过暂存和验证机制防止工作空间污染。

## 功能特性

- **文件暂存**: 将文件暂存到缓存区域，等待验证
- **智能验证**: 验证文件质量、安全性和 AI 属性
- **安全提交**: 只有验证通过的文件才能提交到工作空间
- **自动清理**: 自动清理过期文件，释放缓存空间
- **状态监控**: 实时查看缓存状态和统计信息

## 安装

缓存系统已包含在项目中，无需额外安装。

## 使用方法

### 1. 初始化缓存系统

首次使用前需要初始化缓存系统：

```powershell
.\scripts\cache-manager.ps1 -Operation "init-cache" -ProjectPath "."
```

这将创建以下目录结构：
```
.cache/
├── cache-config.json    # 缓存配置文件
├── metadata.json        # 缓存元数据
├── staging/            # 暂存区域
└── validated/          # 验证通过区域
```

### 2. 暂存文件

将文件暂存到缓存区域进行验证：

```powershell
.\scripts\cache-manager.ps1 -Operation "stage-file" -ProjectPath "." -FilePath "example.js"
```

或者直接提供内容：

```powershell
.\scripts\cache-manager.ps1 -Operation "stage-file" -ProjectPath "." -FilePath "new-file.js" -Content "// AI generated code"
```

暂存时会检查：
- 文件扩展名是否允许
- 文件大小是否超过限制
- 是否包含禁止的模式（如密码、密钥等）
- 是否包含 AI 属性标识

### 3. 验证暂存文件

验证暂存区域中的文件：

```powershell
.\scripts\cache-manager.ps1 -Operation "validate-staged" -ProjectPath "."
```

验证包括：
- 文件大小检查
- 禁止模式检查
- AI 属性检查
- 语法验证

验证通过的文件会移动到 `validated/` 目录。

### 4. 提交验证通过的文件

将验证通过的文件提交到工作空间和 Git：

```powershell
.\scripts\cache-manager.ps1 -Operation "commit-staged" -ProjectPath "." -Message "Add validated AI-generated code"
```

这将：
- 将文件复制到原始位置
- 在 Git 中暂存文件
- 创建 Git 提交

### 5. 清理缓存

清理过期的缓存文件：

```powershell
.\scripts\cache-manager.ps1 -Operation "cleanup-cache" -ProjectPath "."
```

### 6. 查看缓存状态

查看缓存系统的当前状态：

```powershell
.\scripts\cache-manager.ps1 -Operation "cache-status" -ProjectPath "."
```

显示信息包括：
- 配置信息
- 统计数据
- 当前暂存的文件
- 当前验证通过的文件

## 配置选项

编辑 `.cache/cache-config.json` 来自定义配置：

```json
{
  "version": "1.0.0",
  "maxCacheAge": 86400,           // 最大缓存时间（秒）
  "maxCacheSize": 104857600,      // 最大缓存大小（字节）
  "validationRules": {
    "maxFileSize": 1048576,       // 最大文件大小（字节）
    "allowedExtensions": [        // 允许的文件扩展名
      ".js", ".ts", ".jsx", ".tsx", ".py"
    ],
    "prohibitedPatterns": [       // 禁止的模式
      "password", "api_key", "secret"
    ],
    "requireAIAttribution": true  // 是否要求 AI 属性
  },
  "autoCleanup": true,            // 是否自动清理
  "cleanupInterval": 3600         // 清理间隔（秒）
}
```

## 文件命名约定

AI 生成的文件应该包含以下属性：

```javascript
/**
 * @file filename.js
 * @author AI Assistant (Claude 3.5 Sonnet)
 * @created 2026-01-13
 * @reviewed [PENDING]
 * @status draft
 */
```

## 工作流程

典型的 AI 文件管理工作流程：

1. **生成文件**: AI 生成代码文件
2. **添加属性**: 在文件中添加 AI 属性标识
3. **暂存文件**: 使用 `stage-file` 暂存文件
4. **验证文件**: 使用 `validate-staged` 验证文件
5. **修复问题**: 如果验证失败，修复问题后重新暂存
6. **提交文件**: 使用 `commit-staged` 提交验证通过的文件
7. **清理缓存**: 定期使用 `cleanup-cache` 清理缓存

## 注意事项

- 暂存的文件不会直接影响工作空间
- 只有验证通过的文件才能提交
- 过期的文件会被自动清理
- 敏感信息（密码、密钥等）会被检测并阻止
- 建议定期清理缓存以释放空间

## 故障排除

### 问题：缓存初始化失败

**解决方案**：
- 检查是否有足够的磁盘空间
- 确保有写入权限
- 删除 `.cache` 目录后重新初始化

### 问题：文件暂存失败

**解决方案**：
- 检查文件扩展名是否在允许列表中
- 确保文件大小不超过限制
- 移除文件中的敏感信息
- 添加 AI 属性标识

### 问题：验证失败

**解决方案**：
- 检查文件语法是否正确
- 移除禁止的模式
- 添加 AI 属性标识
- 查看详细的错误信息

### 问题：提交失败

**解决方案**：
- 确保有验证通过的文件
- 检查 Git 状态
- 确保提交消息格式正确
- 检查 Git hooks 是否阻止提交

## 集成到开发流程

### 与 Git Hooks 集成

可以在 Git hooks 中集成缓存管理：

```bash
# .git/hooks/pre-commit
powershell -ExecutionPolicy Bypass -File scripts\cache-manager.ps1 -Operation "validate-staged" -ProjectPath "."
```

### 与 CI/CD 集成

在 CI/CD 流程中添加缓存验证：

```yaml
- name: Validate AI files
  run: |
    powershell -ExecutionPolicy Bypass -File scripts\cache-manager.ps1 -Operation "validate-staged" -ProjectPath "."
```

## 最佳实践

1. **定期清理缓存**: 每天或每周清理一次缓存
2. **验证文件质量**: 在暂存前手动检查文件质量
3. **添加完整属性**: 确保所有 AI 文件都有完整的属性标识
4. **监控缓存状态**: 定期查看缓存状态，了解使用情况
5. **备份重要文件**: 在提交前备份重要的文件
6. **使用版本控制**: 即使使用缓存管理，也要使用 Git 版本控制

## 技术支持

如有问题或建议，请联系项目维护者。

---

*Generated by iFlow CLI*
*Date: 2026-01-13*