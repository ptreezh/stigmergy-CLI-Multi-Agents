# iFlow CLI会话记忆持久化机制研究报告

## 概述
iFlow CLI是Stigmergy多AI CLI协作系统的核心组件，具有完整的会话记忆持久化机制。

## 记忆存储架构

### 1. 双层存储结构
iFlow CLI采用双层记忆存储架构：

#### 全局记忆 (Global Memory)
- **存储位置**: `~/.stigmergy/memory.json`
- **作用范围**: 跨项目的全局会话记录
- **数据格式**: JSON格式
- **管理类**: `MemoryManager`

#### 项目记忆 (Project Memory)
- **存储位置**: 项目根目录 `STIGMERGY.md`
- **作用范围**: 当前项目的特定记忆
- **数据格式**: Markdown格式
- **内容**: 项目配置、CLI工具信息、协作指令

### 2. 记忆数据结构

#### 全局记忆数据结构
```json
{
  "version": "1.0.0",
  "lastUpdated": "2025-12-07T10:08:36.482Z",
  "interactions": [
    {
      "timestamp": "2025-12-07T10:08:36.478Z",
      "tool": "claude",
      "prompt": "translate this text using claude",
      "response": "Claude CLI is not available",
      "duration": 0
    }
  ],
  "collaborations": []
}
```

#### 项目记忆数据结构
- 项目名称和创建时间
- 可用AI CLI工具列表
- 跨CLI协作模式说明
- 各CLI工具的文档链接

## 会话持久化机制

### 1. 记忆记录流程
1. **交互捕获**: 每次CLI调用都会记录交互信息
2. **数据结构化**: 将交互信息转换为标准JSON格式
3. **时间戳记录**: 精确记录交互时间
4. **持久化写入**: 自动写入全局记忆文件

### 2. 记忆加载机制
1. **项目识别**: 通过当前工作目录识别项目
2. **记忆检索**: 读取全局记忆和项目记忆
3. **上下文重建**: 根据历史记录重建会话上下文
4. **协作激活**: 启用跨CLI协作功能

### 3. 跨会话持久化特性
- **时间连续性**: 保持完整的时间戳记录
- **工具关联**: 记录不同CLI工具间的协作关系
- **项目隔离**: 不同项目的记忆相互隔离
- **全局共享**: 跨项目的通用记忆可共享

## 技术实现细节

### 1. MemoryManager类实现
```javascript
class MemoryManager {
  constructor() {
    this.globalMemoryFile = path.join(os.homedir(), '.stigmergy', 'memory.json');
    this.projectMemoryFile = path.join(process.cwd(), 'STIGMERGY.md');
  }

  async getGlobalMemory() {
    // 读取全局记忆文件
  }

  async updateGlobalMemory(updateFn) {
    // 更新全局记忆文件
  }

  async addInteraction(tool, prompt, response, duration = 0) {
    // 添加交互记录
  }
}
```

### 2. 关键特性
- **自动创建**: 记忆文件不存在时自动创建
- **错误处理**: 文件损坏时返回默认结构
- **原子操作**: 确保数据写入的完整性
- **目录管理**: 自动创建必要的目录结构

## 安全与隐私

### 1. 数据存储
- **本地存储**: 所有记忆数据存储在本地
- **用户控制**: 用户完全控制记忆数据
- **无云端同步**: 不涉及云端数据传输

### 2. 敏感信息处理
- **明文存储**: 当前版本为明文存储
- **用户责任**: 用户需自行管理敏感信息
- **改进空间**: 可考虑添加加密功能

## 配置与定制

### 1. 配置文件位置
- **全局配置**: `~/.stigmergy/config.json`
- **项目配置**: 项目根目录 `STIGMERGY.md`
- **Hook配置**: `~/.iflow/hooks/`

### 2. 可定制选项
- **记忆保留策略**: 可配置记忆保留时长
- **工具偏好**: 可设置默认使用的CLI工具
- **协作模式**: 可定制跨CLI协作行为

## 性能特点

### 1. 优势
- **轻量级**: JSON格式存储，读写速度快
- **增量更新**: 只更新变化的记忆数据
- **异步操作**: 使用Promise确保非阻塞

### 2. 潜在问题
- **文件大小**: 长期使用可能导致文件过大
- **并发安全**: 多进程同时访问可能存在竞争条件
- **内存占用**: 大量历史记录可能影响内存使用

## 与其他CLI的协作

### 1. 跨CLI通信机制
- **Hook系统**: 通过Hook实现CLI间通信
- **自然语言**: 支持自然语言指令触发协作
- **结果共享**: 协作结果自动记录到记忆中

### 2. 协作记忆
- **工具链**: 记录CLI工具间的调用链
- **上下文传递**: 保持协作过程中的上下文连续性
- **结果整合**: 整合多个CLI的输出结果

## 总结

iFlow CLI的会话记忆持久化机制具有以下特点：

### 优势
1. **完整的双层架构**: 全局+项目记忆覆盖不同使用场景
2. **结构化存储**: JSON格式便于数据处理和分析
3. **自动化管理**: 无需手动管理记忆文件
4. **跨CLI协作**: 支持多AI工具协作的记忆记录

### 改进空间
1. **安全性**: 可添加数据加密功能
2. **性能**: 可优化大量数据的处理性能
3. **清理机制**: 可添加自动清理过期记忆的功能
4. **搜索功能**: 可增强记忆数据的搜索和检索能力

### 技术评级
- **完整性**: ⭐⭐⭐⭐⭐ (5/5)
- **安全性**: ⭐⭐⭐ (3/5)
- **性能**: ⭐⭐⭐⭐ (4/5)
- **易用性**: ⭐⭐⭐⭐⭐ (5/5)
- **扩展性**: ⭐⭐⭐⭐ (4/5)

iFlow CLI的记忆机制为多AI CLI协作提供了坚实的基础，是当前研究的参考基准。