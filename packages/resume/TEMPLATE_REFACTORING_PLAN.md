# 模板系统重构方案

## 问题分析

### 当前方案的缺陷
1. **字符串转义地狱** - TypeScript模板字符串中嵌套JavaScript代码，需要多层转义
2. **维护困难** - 9000+字符的代码全部压缩在一个字符串中
3. **中文编码问题** - 注释中的中文字符在转义过程中容易出错
4. **可读性差** - 无法使用IDE的语法高亮和代码格式化
5. **调试困难** - 生成的代码出错时难以定位源头

### 示例问题
```typescript
// 当前方式 - 需要转义反引号、${}、换行符等
return `// Generated code
const result = \`template \${variable}\`;  // 转义地狱
`;
```

## 新方案：基于模板文件的系统

### 架构设计

```
packages/resume/
├── src/
│   └── utils/
│       └── CodeGenerator.ts  (重构后只负责读取和变量替换)
└── templates/
    ├── claude-integration.template.js
    ├── gemini-integration.template.js
    ├── qwen-integration.template.js
    ├── iflow-integration.template.js
    ├── codebuddy-integration.template.js
    ├── codex-integration.template.js
    └── qodercli-integration.template.js
```

### 模板文件格式

使用占位符语法：`{{VARIABLE_NAME}}`

**示例: qwen-integration.template.js**
```javascript
// Qwen CLI ResumeSession Integration
// Auto-generated by ResumeSession v{{VERSION}}
// Project: {{PROJECT_PATH}}

const fs = require('fs');
const path = require('path');
const os = require('os');

class SessionScanner {
  scanSessions(cliType, sessionsPath, projectPath) {
    // 真实代码，无需转义
    const sessions = [];
    
    // For Qwen: scan projects/<projectName>/chats/
    if (cliType === 'qwen' && sessionsPath.includes('projects')) {
      const subdirs = fs.readdirSync(sessionsPath);
      for (const subdir of subdirs) {
        const chatsDir = path.join(subdirPath, 'chats');
        if (fs.existsSync(chatsDir)) {
          sessions.push(...this.scanSessionFiles(cliType, chatsDir, projectPath));
        }
      }
    }
    
    return sessions;
  }
}

// ... 完整的真实代码
```

### CodeGenerator重构

```typescript
import { readFileSync } from 'fs';
import { join } from 'path';

export class CodeGenerator {
  private templatesDir: string;

  constructor() {
    // 指向templates目录
    this.templatesDir = join(__dirname, '..', '..', 'templates');
  }

  /**
   * 生成集成代码（新方法）
   */
  async generateIntegration(cliType: string, projectPath: string, config: ShareMemConfig): Promise<void> {
    // 1. 读取模板文件
    const templatePath = join(this.templatesDir, `${cliType}-integration.template.js`);
    const template = readFileSync(templatePath, 'utf8');

    // 2. 变量替换
    const code = this.replaceVariables(template, {
      VERSION: config.version,
      PROJECT_PATH: projectPath,
      HOME_DIR: require('os').homedir()
    });

    // 3. 写入目标位置
    const integrationPath = this.getIntegrationPath(cliType, projectPath);
    mkdirSync(join(integrationPath, '..'), { recursive: true });
    writeFileSync(integrationPath, code);
  }

  /**
   * 简单的变量替换
   */
  private replaceVariables(template: string, variables: Record<string, string>): string {
    let result = template;
    for (const [key, value] of Object.entries(variables)) {
      const placeholder = `{{${key}}}`;
      result = result.replace(new RegExp(placeholder, 'g'), value);
    }
    return result;
  }
}
```

## 优势对比

| 特性 | 当前方案 | 新方案 |
|------|---------|--------|
| **可读性** | ❌ 字符串转义难读 | ✅ 真实JavaScript代码 |
| **维护性** | ❌ 修改需要处理转义 | ✅ 直接编辑模板文件 |
| **IDE支持** | ❌ 无语法高亮 | ✅ 完整IDE支持 |
| **调试** | ❌ 难以定位错误 | ✅ 清晰的错误位置 |
| **中文支持** | ❌ 编码问题 | ✅ UTF-8原生支持 |
| **版本控制** | ❌ 大字符串难diff | ✅ 清晰的git diff |
| **测试** | ❌ 难以单独测试模板 | ✅ 可直接测试模板文件 |

## 实施步骤

### 第1步：创建templates目录结构
```bash
mkdir -p packages/resume/templates
```

### 第2步：迁移现有模板
1. 从 `.qwen/plugins/resumesession-history.js` 提取真实代码
2. 替换硬编码值为 `{{VARIABLE}}` 占位符
3. 保存为 `qwen-integration.template.js`

### 第3步：重构CodeGenerator.ts
1. 移除 `generateClaudeTemplate()` 等方法中的大字符串
2. 实现 `readTemplate()` 和 `replaceVariables()` 方法
3. 更新 `generateIntegration()` 使用新方法

### 第4步：迁移所有CLI模板
- Claude (7128字符) → `claude-integration.template.js`
- Gemini (13878字符) → `gemini-integration.template.js`
- Qwen (9191字符) → `qwen-integration.template.js`
- 其他5个CLI → 对应模板文件

### 第5步：测试验证
```javascript
// 测试模板系统
const generator = new CodeGenerator();
await generator.generateIntegration('qwen', '/test/project', config);

// 验证生成的代码
const generated = fs.readFileSync('.qwen/plugins/resumesession-history.js', 'utf8');
assert(generated.includes('class SessionScanner'));
assert(generated.includes('/test/project')); // 变量已替换
```

## 兼容性

### 构建系统
- TypeScript编译时需要复制 `templates/` 到 `dist/`
- 更新 `tsconfig.json`:
```json
{
  "compilerOptions": {
    "outDir": "./dist"
  },
  "include": ["src/**/*", "templates/**/*"]
}
```

### NPM打包
- 更新 `package.json`:
```json
{
  "files": [
    "dist/",
    "templates/"
  ]
}
```

## 总结

**当前问题根源**：将9000+字符的JavaScript代码硬编码为TypeScript字符串常量

**解决方案**：使用独立的 `.template.js` 文件 + 简单变量替换

**收益**：
- ✅ 零转义问题
- ✅ 完整IDE支持
- ✅ 易于维护和调试
- ✅ 清晰的版本控制
- ✅ 可直接运行测试模板文件

**下一步行动**：立即实施这个重构方案
