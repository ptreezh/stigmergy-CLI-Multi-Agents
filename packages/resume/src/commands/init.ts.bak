import chalk from 'chalk';
import inquirer from 'inquirer';
import { existsSync, writeFileSync, mkdirSync } from 'fs';
import { resolve, join } from 'path';
import { CLIScanner } from '../utils/CLIScanner';
import { CodeGenerator } from '../utils/CodeGenerator';
import { ShareMemConfig, InitOptions } from '../types';

export async function initCommand(options: InitOptions): Promise<void> {
  console.log(chalk.blue.bold('ğŸš€ Initializing ResumeSession for cross-CLI session recovery\n'));

  // æ£€æŸ¥å½“å‰ç›®å½•
  const currentDir = process.cwd();
  const configPath = join(currentDir, '.resumesession');

  if (existsSync(configPath) && !options.force) {
    console.log(chalk.yellow('âš ï¸  ResumeSession already initialized in this project.'));
    console.log(chalk.gray(`   Config file: ${configPath}`));

    const { overwrite } = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'overwrite',
        message: 'Do you want to reinitialize?',
        default: false
      }
    ]);

    if (!overwrite) {
      console.log(chalk.gray('âŒ Initialization cancelled.'));
      return;
    }
  }

  // æ‰«æå¯ç”¨çš„CLIå·¥å…·
  console.log(chalk.blue('ğŸ” Scanning for available CLI tools...'));
  const scanner = CLIScanner.getInstance();
  const availableCLIs = await scanner.scanAvailableCLIs();

  if (availableCLIs.length === 0) {
    console.log(chalk.red('âŒ No supported CLI tools found on this system.'));
    console.log(chalk.gray('   Please install at least one supported CLI tool:'));
    console.log(chalk.gray('   - Claude CLI: npm install -g @anthropic-ai/claude-code'));
    console.log(chalk.gray('   - Gemini CLI: npm install -g @google/gemini-cli'));
    console.log(chalk.gray('   - And more...'));
    return;
  }

  console.log(chalk.green(`âœ… Found ${availableCLIs.length} supported CLI tools:\n`));

  // æ˜¾ç¤ºå¯ç”¨å·¥å…·
  availableCLIs.forEach((cli, index) => {
    const status = cli.available ? chalk.green('âœ…') : chalk.red('âŒ');
    const integration = getIntegrationLevelText(cli.integrationLevel);
    console.log(`   ${index + 1}. ${chalk.bold(cli.displayName)} ${status}`);
    console.log(`      Version: ${cli.version || 'unknown'}`);
    console.log(`      Integration: ${integration}`);
    if (cli.sessionsPath) {
      console.log(`      Sessions: ${cli.sessionsPath}`);
    }
    console.log('');
  });

  // é€‰æ‹©è¦é›†æˆçš„CLIå·¥å…·
  const { selectedCLIs } = await inquirer.prompt([
    {
      type: 'checkbox',
      name: 'selectedCLIs',
      message: 'Select CLI tools to integrate with ResumeSession:',
      choices: availableCLIs.map(cli => ({
        name: `${cli.displayName} (${cli.version})`,
        value: cli.name,
        checked: true
      })),
      validate: (input) => {
        if (input.length === 0) {
          return 'Please select at least one CLI tool';
        }
        return true;
      }
    }
  ]);

  if (selectedCLIs.length === 0) {
    console.log(chalk.gray('âŒ No CLI tools selected. Initialization cancelled.'));
    return;
  }

  // éªŒè¯é€‰æ‹©çš„CLIå·¥å…·
  console.log(chalk.blue('\nğŸ”§ Validating selected CLI tools...'));
  const validCLIs: string[] = [];

  for (const cliName of selectedCLIs) {
    const isValid = await scanner.validateCLIForCrossCLI(cliName);
    if (isValid) {
      validCLIs.push(cliName);
      console.log(chalk.green(`   âœ… ${cliName} is ready for cross-CLI integration`));
    } else {
      console.log(chalk.yellow(`   âš ï¸  ${cliName} may have limited functionality`));
      // ä»ç„¶æ·»åŠ åˆ°åˆ—è¡¨ï¼Œä½†å¯èƒ½æœ‰éƒ¨åˆ†åŠŸèƒ½å—é™
      validCLIs.push(cliName);
    }
  }

  // åˆ›å»ºé…ç½®
  const config: ShareMemConfig = {
    projectPath: currentDir,
    selectedCLIs: validCLIs,
    initializedAt: new Date(),
    version: require('../../package.json').version
  };

  // ä¿å­˜é…ç½®
  console.log(chalk.blue('\nğŸ’¾ Saving configuration...'));
  mkdirSync(currentDir, { recursive: true });
  writeFileSync(configPath, JSON.stringify(config, null, 2));

  // ç”Ÿæˆé›†æˆä»£ç 
  console.log(chalk.blue('ğŸ”¨ Generating integration code...'));
  const codeGenerator = new CodeGenerator();

  for (const cliName of validCLIs) {
    try {
      await codeGenerator.generateIntegration(cliName, currentDir, config);
      console.log(chalk.green(`   âœ… Generated integration for ${cliName}`));
    } catch (error) {
      console.log(chalk.red(`   âŒ Failed to generate integration for ${cliName}: ${error instanceof Error ? error.message : String(error)}`));
    }
  }

  // åˆ›å»ºä½¿ç”¨è¯´æ˜
  await generateUsageInstructions(currentDir, validCLIs);

  // å®Œæˆ
  console.log(chalk.green.bold('\nğŸ‰ ResumeSession initialization completed successfully!\n'));

  console.log(chalk.bold('ğŸ“‹ Next steps:'));
  console.log('1. Open your preferred CLI tool in this project directory');
  console.log('2. Try the /history command to see cross-CLI sessions');
  console.log(`3. Configuration saved to: ${chalk.gray(configPath)}`);
  console.log(`4. Run ${chalk.cyan('resumesession status')} to check integration status\n`);

  console.log(chalk.bold('ğŸ’¡ Example commands:'));
  console.log(`   ${chalk.cyan('/history')} - Show all project sessions`);
  console.log(`   ${chalk.cyan('/history --cli claude')} - Show Claude sessions only`);
  console.log(`   ${chalk.cyan('/history --search "react")}')} - Search for "react"`);
  console.log(`   ${chalk.cyan('/history --format timeline')} - Timeline view`);
  console.log(`   ${chalk.cyan('/history --context')} - Get context for continuation\n`);

  console.log(chalk.gray('ğŸ“š For more information, run: resumesession --help'));
}

function getIntegrationLevelText(level: string): string {
  switch (level) {
    case 'native':
      return chalk.green('Native support');
    case 'hook':
      return chalk.yellow('Hook-based');
    case 'external':
      return chalk.blue('External integration');
    default:
      return chalk.gray('Unknown');
  }
}

async function generateUsageInstructions(projectPath: string, selectedCLIs: string[]): Promise<void> {
  const instructions = `# ResumeSession Integration

This project is configured for cross-CLI session recovery with ResumeSession.

## Supported CLI Tools
${selectedCLIs.map(cli => `- ${cli}`).join('\n')}

## Usage

In any of the supported CLI tools, use the following commands:

### Basic Commands
- \`/history\` - Show all project sessions (most recent first)
- \`/history --cli <tool>\` - Show sessions from specific CLI
- \`/history --search <keyword>\` - Search sessions by content
- \`/history --limit <number>\` - Limit number of sessions shown

### Time-based Filtering
- \`/history --today\` - Show today's sessions only
- \`/history --week\` - Show sessions from last 7 days
- \`/history --month\` - Show sessions from last 30 days

### View Formats
- \`/history --format summary\` - Summary view (default)
- \`/history --format timeline\` - Chronological timeline
- \`/history --format detailed\` - Detailed session information
- \`/history --format context\` - Get context to continue conversation

### Examples
\`\`\`bash
# Show all React-related sessions
/history --search "react"

# Show recent Claude sessions
/history --cli claude --today

# Get context from most recent session
/history --format context

# Show timeline of all sessions
/history --format timeline
\`\`\`

## Features
- âœ… Cross-CLI session discovery
- âœ… Project-aware filtering
- âœ… Time-based sorting (most recent first)
- âœ… Content search
- âœ… Context recovery
- âœ… Multiple view formats

## Configuration
Configuration is saved in \`.resumesession\` file in project root.

## Need Help?
Run \`resumesession --help\` for more commands.
`;

  const readmePath = join(projectPath, 'SHAREMEM.md');
  writeFileSync(readmePath, instructions);
}