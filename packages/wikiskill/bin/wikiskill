#!/usr/bin/env node

/**
 * WikiSkill CLI - 独立命令行工具
 */

const { CLIInterface } = require('../src/standalone/index');

/**
 * CLI入口
 */
async function runCLI() {
  const cli = new CLIInterface();
  const args = process.argv.slice(2);
  
  if (args.length === 0) {
    showHelp();
    return;
  }

  const command = args[0];
  const commandArgs = args.slice(1);
  
  // 解析选项
  const options = parseOptions(commandArgs);
  
  try {
    await cli.execute(command, commandArgs.filter(arg => !arg.startsWith('--')), options);
  } catch (error) {
    console.error(`错误: ${error.message}`);
    process.exit(1);
  }
}

/**
 * 显示帮助信息
 */
function showHelp() {
  console.log(`
WikiSkill CLI - Wiki协同编辑工具

用法:
  wikiskill <command> [arguments] [options]

命令:
  init [path]           初始化Wiki系统
  start                  启动Wiki服务
  execute <task>         执行Wiki任务
  status                 查看服务状态
  open [topic]           打开Wiki主题
  list                   列出所有主题
  help                   显示此帮助信息

选项:
  --cli <type>          CLI类型 (claude|stigmergy|gemini|standalone)
  --port <port>         服务端口 (默认: 3000)
  --host <host>         服务主机 (默认: localhost)
  --config <path>       配置文件路径
  --verbose             详细输出
  --version             显示版本信息

示例:
  # 初始化Wiki (独立模式)
  wikiskill init --cli standalone
  
  # 启动服务 (Claude模式)
  wikiskill start --cli claude --port 8080
  
  # 执行任务
  wikiskill execute "参与机器学习词条编辑" --cli claude
  
  # 查看状态
  wikiskill status --verbose

更多信息请访问: https://github.com/ptreezh/stigmergy-CLI-Multi-Agents
  `);
}

/**
 * 解析命令行选项
 */
function parseOptions(args) {
  const options = {};
  
  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    
    if (arg.startsWith('--')) {
      const key = arg.slice(2);
      const nextArg = args[i + 1];
      
      if (nextArg && !nextArg.startsWith('--')) {
        options[key] = nextArg;
        i++;
      } else {
        options[key] = true;
      }
    }
  }
  
  return options;
}

/**
 * 检查环境
 */
function checkEnvironment() {
  const requiredNodeVersion = '16.0.0';
  const currentNodeVersion = process.version;
  
  if (currentNodeVersion < requiredNodeVersion) {
    console.error(`错误: 需要Node.js版本 >= ${requiredNodeVersion}，当前版本: ${currentNodeVersion}`);
    process.exit(1);
  }
  
  // 检查环境变量
  if (!process.env.ANTHROPIC_API_KEY) {
    console.warn('警告: 未设置ANTHROPIC_API_KEY环境变量，Claude功能可能受限');
  }
}

/**
 * 版本信息
 */
function showVersion() {
  const packageJson = require('../package.json');
  console.log(`WikiSkill CLI v${packageJson.version}`);
  console.log(`Node.js ${process.version}`);
  console.log(`Platform: ${process.platform}`);
}

// 主程序
if (require.main === module) {
  // 处理特殊命令
  const command = process.argv[2];
  
  if (command === 'help' || command === '--help' || command === '-h') {
    showHelp();
    return;
  }
  
  if (command === 'version' || command === '--version' || command === '-v') {
    showVersion();
    return;
  }
  
  // 检查环境
  checkEnvironment();
  
  // 运行CLI
  runCLI().catch(error => {
    console.error('CLI运行失败:', error);
    process.exit(1);
  });
}

module.exports = {
  runCLI,
  showHelp,
  parseOptions,
  checkEnvironment,
  showVersion
};