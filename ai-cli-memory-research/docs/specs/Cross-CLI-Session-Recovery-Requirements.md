# 跨CLI会话恢复系统需求文档

## 项目概述

**项目名称**: Cross-CLI Session Recovery (CCSR)
**版本**: 1.0.0
**创建日期**: 2025-12-12
**文档类型**: 需求规范 (Requirements Specification)

### 1.1 项目背景

在当前AI CLI工具生态系统中，开发者经常使用多个不同的AI CLI工具：
- Claude Code (claude)
- Gemini CLI (gemini)
- Qwen Code (qwen)
- IFlow CLI (iflow)
- CodeBuddy CLI (codebuddy)
- Qoder CLI (qodercli)
- Codex CLI (codex)

每个CLI工具都独立维护自己的会话历史，导致：
1. 会话信息碎片化
2. 无法跨CLI工具查看历史
3. 项目知识无法连续积累
4. 开发效率降低

### 1.2 问题陈述

**核心问题**: 跨CLI会话历史无法统一查看和恢复

**具体表现**:
- 在Claude中讨论过的功能，切换到Gemini时无法访问
- Qwen中调试过的问题，在IFlow中需要重新讨论
- 项目相关的知识分散在各个CLI的独立会话中

### 1.3 项目目标

**主要目标**: 实现跨CLI会话历史的统一查看和恢复功能

**具体目标**:
1. **统一会话查看**: 在任何支持的CLI中查看所有CLI的会话历史
2. **智能项目识别**: 自动识别属于同一项目的会话
3. **无缝会话恢复**: 将选中的会话内容导出为新会话的上下文
4. **格式兼容性**: 支持各CLI工具的不同会话格式

### 1.4 项目范围

#### 1.4.1 包含范围

**支持的CLI工具**:
- Claude CLI v2.0.65+
- Gemini CLI v0.19.4+
- Qwen CLI v0.4.0+
- IFlow CLI v0.4.6+
- CodeBuddy CLI v2.10.0+
- Qoder CLI v0.1.15+
- Codex CLI (如果可用)

**核心功能**:
- 跨CLI会话扫描和索引
- 项目级会话聚合
- 会话内容查看和搜索
- 会话导出和格式转换
- 斜杠命令集成(/history)

#### 1.4.2 不包含范围

**不支持的CLI工具**:
- 需要特殊配置的CLI工具
- 不使用标准会话格式的CLI工具

**不包含的功能**:
- 实时会话同步
- CLI工具的功能修改
- 云端会话管理

## 2. 功能需求

### 2.1 核心功能需求

#### 2.1.1 会话扫描功能 (FR-001)

**需求描述**: 系统必须能够扫描和索引所有支持的CLI工具的会话文件

**详细需求**:
- **FR-001-1**: 扫描Claude CLI的会话文件 (`~/.claude/projects/*/*.jsonl`)
- **FR-001-2**: 扫描Gemini CLI的会话文件 (`~/.gemini/tmp/*/chats/session-*.json`)
- **FR-001-3**: 扫描Qwen CLI的会话文件 (`~/.qwen/tmp/*/chats/session-*.json`)
- **FR-001-4**: 扫描IFlow CLI的会话文件 (`~/.iflow/projects/*/session-*.jsonl`)
- **FR-001-5**: 扫描CodeBuddy CLI的会话文件 (`~/.codebuddy/history.jsonl`)
- **FR-001-6**: 扫描Qoder CLI的会话文件 (`~/.qoder/projects/*/*-session.json`)
- **FR-001-7**: 扫描Codex CLI的会话文件 (`~/.codex/history.jsonl`)

**验收标准**:
- 能够扫描所有支持CLI的会话文件
- 正确解析不同CLI的会话文件格式
- 提供扫描进度和错误处理

#### 2.1.2 项目识别功能 (FR-002)

**需求描述**: 系统必须能够准确识别属于同一项目的会话

**详细需求**:
- **FR-002-1**: 支持绝对路径匹配
- **FR-002-2**: 支持Git仓库根目录识别
- **FR-002-3**: 支持项目哈希匹配（Gemini/Qwen格式）
- **FR-002-4**: 支持工作目录标准化
- **FR-002-5**: 提供项目识别的容错机制

**验收标准**:
- 在同一项目目录下能够识别所有相关CLI的会话
- 不会错误关联不同项目的会话
- 提供项目识别的准确率统计

#### 2.1.3 会话展示功能 (FR-003)

**需求描述**: 系统必须提供统一的会话历史查看界面

**详细需求**:
- **FR-003-1**: 按CLI工具分组显示会话
- **FR-003-2**: 显示会话基本信息（时间、消息数、最后消息）
- **FR-003-3**: 提供会话排序功能（按时间、消息数等）
- **FR-003-4**: 提供会话搜索和过滤功能
- **FR-003-5**: 显示CLI特有的元数据（如Qwen的Token统计）

**验收标准**:
- 界面清晰易用
- 信息展示完整
- 搜索响应快速
- 过滤功能有效

#### 2.1.4 会话恢复功能 (FR-004)

**需求描述**: 系统必须支持将选中会话的内容导出为新会话的上下文

**详细需求**:
- **FR-004-1**: 支持Markdown格式导出
- **FR-004-2**: 支持纯文本格式导出
- **FR-004-3**: 支持上下文格式导出
- **FR-004-4**: 提供内容截断和摘要功能
- **FR-004-5**: 保持对话的时序和结构

**验收标准**:
- 导出内容格式正确
- 适合目标CLI工具使用
- 内容完整可读

### 2.2 斜杠命令集成需求

#### 2.2.1 斜杠命令支持 (FR-005)

**需求描述**: 系统必须通过斜杠命令机制集成到各CLI工具中

**详细需求**:
- **FR-005-1**: 在Claude CLI中支持`/history`命令
- **FR-005-2**: 在Gemini CLI中支持`/history`命令
- **FR-005-3**: 在Qwen CLI中支持`/history`命令
- **FR-005-4**: 在IFlow CLI中支持`/history`命令
- **FR-005-5**: 在CodeBuddy CLI中支持`/history`命令

**验收标准**:
- 在支持的CLI中输入`/history`能够正常工作
- 命令响应速度快
- 错误处理机制完善

#### 2.2.2 命令参数支持 (FR-006)

**需求描述**: `/history`命令必须支持参数化的操作

**详细需求**:
- **FR-006-1**: `/history` - 显示所有会话
- **FR-006-2**: `/history search <keyword>` - 搜索会话
- **FR-006-3**: `/history filter <cli>` - 按CLI过滤
- **FR-006-4**: `/history export <session-id>` - 导出会话
- **FR-006-5**: `/history detail <session-id>` - 显示会话详情

**验收标准**:
- 所有参数功能正常
- 参数解析正确
- 提供参数使用帮助

### 2.3 性能需求

#### 2.3.1 扫描性能 (FR-007)

**需求描述**: 系统必须能够高效扫描大量会话文件

**详细需求**:
- **FR-007-1**: 单个项目扫描时间 < 5秒
- **FR-007-2**: 支持1000+会话文件的处理
- **FR-007-3**: 提供增量扫描功能
- **FR-007-4**: 支持并行扫描优化

**验收标准**:
- 满足性能指标
- 内存使用合理
- CPU占用适中

#### 2.3.2 查询性能 (FR-008)

**需求描述**: 会话查询和搜索必须响应快速

**详细需求**:
- **FR-008-1**: 会话列表显示时间 < 2秒
- **FR-008-2**: 搜索响应时间 < 1秒
- **FR-008-3**: 支持分页显示
- **FR-008-4**: 支持缓存机制

**验收标准**:
- 查询响应满足时间要求
- 缓存机制有效
- 用户体验流畅

### 2.4 兼容性需求

#### 2.4.1 CLI版本兼容性 (FR-009)

**需求描述**: 系统必须兼容不同版本的CLI工具

**详细需求**:
- **FR-009-1**: 支持Claude CLI v2.0+
- **FR-009-2**: 支持Gemini CLI v0.19+
- **FR-009-3**: 支持Qwen CLI v0.4+
- **FR-009-4**: 支持IFlow CLI v0.4+
- **FR-009-5**: 提供版本检测和兼容性提示

**验收标准**:
- 在支持的版本范围内正常工作
- 对不支持的版本提供友好提示
- 版本升级不影响功能

#### 2.4.2 操作系统兼容性 (FR-010)

**需求描述**: 系统必须支持主流操作系统

**详细需求**:
- **FR-010-1**: 支持Windows 10/11
- **FR-010-2**: 支持macOS 12+
- **FR-010-3**: 支持Linux (Ubuntu 20.04+)
- **FR-010-4**: 路径处理兼容不同操作系统

**验收标准**:
- 在所有支持的操作系统上正常工作
- 路径处理正确
- 安装和配置简单

## 3. 非功能需求

### 3.1 可用性需求

#### 3.1.1 安装部署 (NFR-001)

**需求描述**: 系统必须简单易用，安装部署过程简便

**详细要求**:
- 一键安装脚本
- 自动依赖检查
- 清晰的安装指引
- 错误诊断和修复建议

#### 3.1.2 用户界面 (NFR-002)

**需求描述**: 用户界面必须直观易用

**详细要求**:
- 符合各CLI工具的使用习惯
- 提供清晰的命令帮助
- 错误信息友好
- 操作流程简单

### 3.2 可靠性需求

#### 3.2.1 错误处理 (NFR-003)

**需求描述**: 系统必须具备完善的错误处理机制

**详细要求**:
- 会话文件解析错误处理
- 网络错误处理
- 权限错误处理
- 数据损坏检测和恢复

#### 3.2.2 数据安全 (NFR-004)

**需求描述**: 系统必须保护用户数据安全

**详细要求**:
- 不修改原始会话文件
- 本地数据处理，不上传云端
- 敏感信息脱敏
- 访问权限控制

### 3.3 可维护性需求

#### 3.3.1 代码质量 (NFR-005)

**需求描述**: 代码必须易于维护和扩展

**详细要求**:
- 模块化设计
- 清晰的代码结构
- 完整的注释和文档
- 单元测试覆盖

#### 3.3.2 配置管理 (NFR-006)

**需求描述**: 系统必须支持灵活的配置管理

**详细要求**:
- 配置文件支持
- 环境变量支持
- 默认配置合理
- 配置验证机制

## 4. 约束条件

### 4.1 技术约束

- 必须基于Node.js/TypeScript实现
- 必须支持ES2020+语法
- 不能修改CLI工具的源代码
- 不能依赖云端服务

### 4.2 运行环境约束

- 必须支持离线使用
- 必须支持本地数据存储
- 必须兼容现有的CLI工具

### 4.3 性能约束

- 内存使用 < 100MB
- 启动时间 < 2秒
- 文件扫描时间 < 5秒

### 4.4 安全约束

- 不能泄露用户的会话内容
- 不能存储敏感信息
- 必须遵守各CLI工具的隐私政策

## 5. 验收标准

### 5.1 功能验收标准

| 功能需求 | 验收方法 | 预期结果 |
|---------|---------|---------|
| FR-001 | 测试会话扫描功能 | 成功扫描所有CLI的会话 |
| FR-002 | 测试项目识别功能 | 准确识别项目会话 |
| FR-003 | 测试会话展示功能 | 正确显示会话信息 |
| FR-004 | 测试会话恢复功能 | 成功导出会话内容 |
| FR-005 | 测试斜杠命令功能 | 各CLI中正常使用/history |
| FR-006 | 测试命令参数功能 | 所有参数正常工作 |

### 5.2 性能验收标准

| 性能需求 | 测试方法 | 验收标准 |
|---------|---------|---------|
| FR-007 | 性能测试 | 扫描时间<5秒 |
| FR-008 | 查询测试 | 查询响应<2秒 |

### 5.3 兼容性验收标准

| 兼容性需求 | 测试方法 | 验收标准 |
|-----------|---------|---------|
| FR-009 | 版本测试 | 支持的版本正常工作 |
| FR-010 | 操作系统测试 | 各OS上正常工作 |

## 6. 项目交付物

### 6.1 软件交付物

1. **核心软件包** (`cross-cli-session-manager`)
2. **安装脚本** (支持npm, curl, wget等方式)
3. **配置文件模板** (各CLI的commands配置)
4. **用户文档** (安装、使用、故障排除)

### 6.2 文档交付物

1. **需求文档** (本文档)
2. **设计文档** (技术设计规范)
3. **用户手册** (安装和使用指南)
4. **API文档** (开发者接口文档)
5. **测试报告** (功能、性能、兼容性测试)

## 7. 项目里程碑

### 7.1 Phase 1: 核心功能 (MVP)
**时间**: 2周
**目标**: 实现基本的跨CLI会话扫描和查看功能
**交付物**:
- 核心扫描引擎
- 基本的Web界面
- 简单的导出功能

### 7.2 Phase 2: 斜杠命令集成
**时间**: 1周
**目标**: 实现各CLI的斜杠命令集成
**交付物**:
- 斜杠命令模板
- CLI集成脚本
- 参数化命令功能

### 7.3 Phase 3: 高级功能
**时间**: 1周
**目标**: 实现高级搜索、过滤、分析功能
**交付物**:
- 搜索引擎
- 过滤系统
- 会话分析功能

### 7.4 Phase 4: 优化和发布
**时间**: 1周
**目标**: 性能优化、错误处理、文档完善
**交付物**:
- 性能优化版本
- 完整用户文档
- 发布包

## 8. 风险评估

### 8.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| CLI会话格式变化 | 中 | 高 | 版本兼容性检查、格式适配层 |
| 斜杠命令机制变化 | 中 | 中 | 多种部署方式、降级方案 |
| 性能问题 | 低 | 中 | 性能测试、优化算法 |

### 8.2 业务风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 用户接受度低 | 中 | 中 | 用户调研、易用性测试 |
| CLI工具不支持 | 低 | 高 | 支持多种集成方式 |

## 9. 附录

### 9.1 术语表

| 术语 | 定义 |
|------|------|
| CLI | Command Line Interface |
| 会话 | 用户与AI助手的一轮完整对话 |
| 项目识别 | 判断会话是否属于当前项目的算法 |
| 斜杠命令 | 以/开头的特殊命令 |
| 规范驱动开发 | Specification-Driven Development (SDD) |

### 9.2 参考资料

- [Claude CLI Documentation](https://docs.anthropic.com/claude-code)
- [Gemini CLI GitHub](https://github.com/google-gemini/gemini-cli)
- [Qwen CLI GitHub](https://github.com/QwenLM/qwen-code)
- [IFlow CLI Documentation](https://iflow.ai)
- [Specification-Driven Development](https://github.com/github/spec-kit)

---

**文档版本**: 1.0.0
**最后更新**: 2025-12-12
**审批状态**: 待审批
**作者**: Cross-CLI Session Recovery Team