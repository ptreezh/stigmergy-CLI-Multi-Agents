# ResumeSession - 跨 CLI 会话恢复工具

跨多个 CLI 工具恢复和管理会话历史的工具。

## 功能特性

- **智能项目识别** - 自动识别当前项目目录并过滤相关会话
- **跨 CLI 支持** - 支持任何常见 CLI 工具
- **自动检测** - 自动扫描常见 CLI 的会话存储位置，无需手动配置
- **开箱即用** - 无需配置，安装即可使用
- **多种恢复模式** - 支持恢复最新会话、显示会话列表、按 CLI 过滤等
- **灵活的参数控制** - 通过参数控制显示的会话数量和范围
- **相对时间显示** - 显示会话的相对时间（如"5分钟前"）

## 安装方式

### 方式 1: 全局安装（推荐）

```bash
# 在工具目录下执行
npm install -g .

# 安装后可以在任何位置使用
resume-session
```

### 方式 2: 直接使用 Node.js

```bash
# 在工具目录下执行
node independent-resume.js [参数]
```

### 方式 3: 创建软链接（Linux/Mac）

```bash
# 创建可执行链接
ln -s $(pwd)/independent-resume.js ~/.local/bin/resume-session

# 添加到 PATH（如果需要）
export PATH="$PATH:$HOME/.local/bin"
```

## 使用方式

### 基本用法

```bash
# 恢复当前项目目录的最新会话（不论会话是哪个 CLI 产生的）
resume-session

# 或使用 Node.js
node independent-resume.js
```

### 显示多个会话

```bash
# 显示当前项目目录相关的最近 5 个会话摘要列表
resume-session 5

# 显示最近 10 个会话
resume-session 10
```

### 按 CLI 过滤

```bash
# 显示当前项目的 iFlow 会话
resume-session iflow

# 显示当前项目最近 3 个 iFlow 会话
resume-session iflow 3

# 显示当前项目的 Claude 会话
resume-session claude

# 显示当前项目最近 5 个 Gemini 会话
resume-session gemini 5
```

### 显示所有会话

```bash
# 显示当前项目所有 CLI 的会话列表
resume-session --all
```

### 显示完整会话列表

```bash
# 显示所有 CLI 所有项目的会话分类列表
resume-session --complete
```

### 显示帮助

```bash
resume-session --help
```

## 参数说明

| 参数 | 说明 |
|------|------|
| 无参数 | 恢复当前项目目录的最新会话（不论哪个 CLI） |
| `[数字]` | 显示当前项目目录相关的最近 N 个会话摘要列表 |
| `[CLI名称]` | 显示对应 CLI 关于本项目目录相关的会话列表 |
| `[CLI名称] [数字]` | 显示对应 CLI 关于本项目目录相关的最近 N 个会话 |
| `--all` | 显示当前项目所有 CLI 的会话列表 |
| `--complete` | 显示所有 CLI 所有项目的会话分类列表 |
| `--help` | 显示帮助信息 |

## 配置要求

### 无需手动配置！

此工具**完全自动化**，采用两层配置策略：

### 策略 1: 优先使用 Stigmergy（如果已安装）

如果系统安装了 stigmergy 并且已配置：
- 自动读取 `~/.stigmergy/config.json`
- 使用 stigmergy 的扫描结果
- 提供最准确的 CLI 检测
- 支持自定义 CLI 路径和多个实例

### 策略 2: 自动检测（后备方案）

如果没有 stigmergy 或没有配置：
- 自动扫描常见 CLI 的会话存储位置
- 开箱即用，无需任何配置
- 支持多个候选路径
- 适用于大多数安装场景

### 自动扫描位置

工具会自动扫描以下位置（每个 CLI 扫描多个候选路径）：

**Linux/Mac:**
- `~/.cli-name/projects/`
- `~/.config/cli-name/projects/`

**Windows:**
- `~/AppData/Roaming/cli-name/projects/`

### 支持的 CLI

工具自动检测以下 CLI 工具：
- Claude
- Gemini
- Qwen
- iFlow
- CodeBuddy
- Codex
- QoderCLI
- Kode

### 自定义安装

如果 CLI 安装在自定义位置：
- **有 stigmergy**: 在 stigmergy 中配置，获得最佳效果
- **无 stigmergy**: 工具自动扫描多个候选路径，找到第一个有效的位置

## 工作原理

1. **配置加载** - 优先从 stigmergy 获取配置，如果没有则使用自动检测
2. **会话扫描** - 扫描已检测到 CLI 的会话目录
3. **项目识别** - 通过当前工作目录和会话文件路径智能匹配相关项目
4. **会话排序** - 按修改时间排序会话，最新的排在前面
5. **内容提取** - 自动提取会话内容并生成摘要
6. **智能过滤** - 根据参数过滤和显示相应的会话

## 使用场景

### 场景 1: 快速恢复上次对话

你正在使用某个 CLI 工具开发项目，突然想恢复上次的对话内容：

```bash
# 在项目目录下执行
resume-session
```

工具会自动找到当前项目相关的最新会话并显示完整内容。

### 场景 2: 查看最近几次会话

你想查看最近几次的会话历史，选择要恢复的会话：

```bash
# 显示最近 5 次会话
resume-session 5
```

### 场景 3: 查看特定 CLI 的会话

你只关心某个特定 CLI 的会话历史：

```bash
# 查看 iFlow 的所有会话
resume-session iflow

# 查看 Claude 的最近 3 次会话
resume-session claude 3
```

### 场景 4: 查看项目的所有会话

你想查看当前项目所有 CLI 的会话历史：

```bash
resume-session --all
```

### 场景 5: 查看所有项目的会话

你想查看所有项目的所有会话：

```bash
resume-session --complete
```

### 场景 6: 切换工作目录后恢复

你在不同的项目目录下工作，想快速恢复该项目的最新会话：

```bash
cd ~/projects/my-app
resume-session

cd ~/projects/another-project
resume-session
```

工具会根据当前工作目录自动识别项目并显示对应的会话。

## 项目识别机制

工具使用以下策略识别当前项目的会话（按优先级）：

1. **精确匹配**: 项目名称与当前目录名完全匹配
2. **路径包含**: 项目名称包含在当前工作目录路径中
3. **名称包含**: 当前目录名包含在项目名称中
4. **文件路径**: 会话文件路径包含当前工作目录路径

所有匹配都是大小写不敏感的。

## 输出格式

### 完整会话内容

```
================================================================================
会话来源: iFlow
项目: my-project
时间: 2026/1/13 14:30:25 (5分钟前)
会话ID: abc123
================================================================================

[User]: 请帮我创建一个 React 组件
[Assistant]: 好的，我来帮你创建一个 React 组件...
...

================================================================================
```

### 会话列表

```
找到 5 个会话 (显示前 5 个)：
================================================================================

[1] iFlow - my-project
    时间: 2026/1/13 14:30:25 (5分钟前)
    会话ID: abc123
    摘要: [User]: 请帮我创建一个 React 组件 [Assistant]: 好的，我来帮你创建...
--------------------------------------------------------------------------------

[2] Claude - my-project
    时间: 2026/1/13 12:15:10 (2小时前)
    会话ID: def456
    摘要: [User]: 如何优化这个函数？ [Assistant]: 可以考虑使用缓存...
--------------------------------------------------------------------------------
...
```

### 按 CLI 分组

```
================================================================================
会话列表（按 CLI 分组）
================================================================================

iFlow (2 个会话)
--------------------------------------------------------------------------------
  [1] my-project - 2026/1/13 14:30:25 (5分钟前)
      会话ID: abc123
  [2] another-project - 2026/1/12 10:20:15 (1天前)
      会话ID: xyz789

Claude (3 个会话)
--------------------------------------------------------------------------------
  [1] my-project - 2026/1/13 12:15:10 (2小时前)
      会话ID: def456
  [2] test-project - 2026/1/11 16:45:30 (2天前)
      会话ID: ghi012
  [3] demo-project - 2026/1/10 09:30:00 (3天前)
      会话ID: jkl345

================================================================================
```

## 注意事项

1. **工作目录**: 建议在项目目录下使用工具，这样可以更准确地识别项目相关的会话
2. **会话格式**: 工具尝试自动提取会话内容，但不同 CLI 的会话格式可能不同
3. **权限问题**: 确保工具对 CLI 会话目录有读取权限
4. **项目匹配**: 如果项目名称与目录名不完全匹配，工具会尝试多种匹配策略

## 故障排查

### 问题: 未找到任何会话

**原因**: 可能是 CLI 工具还未创建会话，或者会话目录不存在

**解决**:
- 确保至少使用过一个 CLI 工具并创建了会话
- 检查 CLI 会话目录是否存在
- 使用 `--complete` 参数查看所有会话
- 工具会优先使用 stigmergy 配置，如果没有则自动扫描常见位置

### 问题: CLI 未被检测到

**原因**: CLI 可能安装在自定义位置，或尚未创建会话

**解决**:
- **有 stigmergy**: 在 stigmergy 中配置 CLI 路径
- **无 stigmergy**: 工具会自动扫描多个候选路径
- 确保 CLI 的会话目录可访问
- 检查 CLI 是否已创建任何会话

### 问题: 当前项目未找到相关会话

**原因**: 可能是当前工作目录不在任何已知项目中，或者项目名称匹配失败

**解决**:
- 确保在正确的项目目录下使用工具
- 使用 `--complete` 参数查看所有项目的会话
- 检查会话的项目名称是否与当前目录匹配
- 尝试使用项目目录的父目录运行工具

### 问题: 找到了错误的会话

**原因**: 项目名称匹配策略可能匹配到了其他相似的项目

**解决**:
- 使用 `--all` 查看所有匹配的会话
- 使用 CLI 名称参数过滤特定 CLI 的会话
- 检查项目名称是否与其他项目相似

### 问题: 无法读取会话内容

**原因**: 会话文件可能损坏或格式不支持

**解决**:
- 检查会话文件是否为有效的 JSON 格式
- 确认会话文件没有被其他程序锁定
- 检查文件权限

## 开发和贡献

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License

## 作者

stigmergy