# é”™è¯¯æ•™è®­è®°å½• (LESSONS LEARNED)

æœ¬æ–‡æ¡£è®°å½• Stigmergy é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é‡å¤§é”™è¯¯å’Œç»éªŒæ•™è®­ï¼Œ**å¿…é¡»ä»”ç»†é˜…è¯»å¹¶é¿å…é‡å¤çŠ¯é”™**ã€‚

---

## ğŸ”´ è‡´å‘½é”™è¯¯ #1: æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼è½¬ä¹‰

**æ—¥æœŸ**: 2025-12-25
**å½±å“**: ç”Ÿäº§ç¯å¢ƒè¯­æ³•é”™è¯¯ï¼Œæ‰€æœ‰ CLI å·¥å…·çš„ ResumeSession é›†æˆå¤±æ•ˆ
**ä¿®å¤ç‰ˆæœ¬**: v1.3.2-beta.3
**è°ƒè¯•æ—¶é—´**: çº¦ 2 å°æ—¶
**å¤±è´¥å°è¯•**: 3 æ¬¡

### é—®é¢˜æè¿°

ç”Ÿæˆçš„ `resumesession-history.js` æ–‡ä»¶åŒ…å«è¯­æ³•é”™è¯¯ï¼š

```javascript
SyntaxError: Invalid or unexpected token
  at resumesession-history.js:515
  const cleanInput = input.replace(/^\\/?stigmergy-resume\s*/i, '').trim();
                                                            ^^^^^^^
```

### é”™è¯¯ä»£ç 

**æ–‡ä»¶**: `src/core/coordination/nodejs/generators/ResumeSessionGenerator.js`
**ä½ç½®**: Line 537, 627

```javascript
// âŒ é”™è¯¯å†™æ³•
const cleanInput = input.replace(/^\\\\/?\${commandName}\\s*/i, '').trim();
const parts = cleanInput.split(/\\\\s+/).filter(p => p.length > 0);
```

### æ ¹æœ¬åŸå› åˆ†æ

#### é”™è¯¯ #1: é˜»æ­¢äº†æ¨¡æ¿æ’å€¼

```javascript
\${commandName}  // âŒ è¿™ä¼šç”Ÿæˆå­—é¢é‡ "${commandName}"ï¼Œè€Œä¸æ˜¯æ’å€¼åçš„å€¼ï¼
${commandName}   // âœ… è¿™æ‰ä¼šæ’å€¼ç”Ÿæˆ "/stigmergy-resume"
```

**é”™è¯¯åæœ**ï¼šç”Ÿæˆçš„ä»£ç ä¸­åŒ…å« `${commandName}` å­—é¢é‡ï¼Œå¯¼è‡´è¯­æ³•é”™è¯¯ã€‚

#### é”™è¯¯ #2: æ­£åˆ™å­—é¢é‡ä¸­çš„ `/` å†²çª

```javascript
// å½“ commandName = "/stigmergy-resume" æ—¶
// ç”Ÿæˆçš„ä»£ç ï¼š
const cleanInput = input.replace(/^\\/?\/stigmergy-resume\s*/i, '').trim();
//                              â†‘ ç¬¬ä¸€ä¸ª / å…³é—­äº†æ­£åˆ™å­—é¢é‡
//                                stigmergy-resume\s*/i  â† è¿™éƒ¨åˆ†å˜æˆäº†æ— å…³ä»£ç 
```

**é”™è¯¯åæœ**ï¼šæ­£åˆ™è¡¨è¾¾å¼è¢«æå‰å…³é—­ï¼Œåç»­ä»£ç å˜æˆè¯­æ³•é”™è¯¯ã€‚

#### é”™è¯¯ #3: åæ–œæ è½¬ä¹‰è®¡ç®—é”™è¯¯

```
æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰å±‚çº§ï¼š
æºæ–‡ä»¶ â†’ æ¨¡æ¿å­—ç¬¦ä¸² â†’ ç”Ÿæˆä»£ç  â†’ æ­£åˆ™è¡¨è¾¾å¼

é”™è¯¯çš„è®¡ç®—ï¼š
æºæ–‡ä»¶å†™ï¼š/^\\\\/?\${commandName}\\s*/i
æœŸæœ›ç”Ÿæˆï¼š/^\\/?stigmergy-resume\s*/i
å®é™…ç”Ÿæˆï¼š/^\\/?${commandName}\s*/i  â† æœªæ’å€¼ + æ­£åˆ™ç ´å
```

### æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ

```javascript
// âœ… æ­£ç¡®å†™æ³•
const cleanInput = input.replace(
  new RegExp('^\\\\\\\\/?' + '${commandName}' + '\\\\\s*', 'i'),
  ''
).trim();
const parts = cleanInput.split(/\\\s+/).filter(p => p.length > 0);
```

### è½¬ä¹‰è®¡ç®—å…¬å¼

```
æºæ–‡ä»¶ä¸­çš„åæ–œæ æ•° = ç›®æ ‡åæ–œæ æ•° Ã— 2^(åµŒå¥—å±‚æ•°)
```

**å®é™…åº”ç”¨**ï¼š

| ç›®æ ‡ | åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­å†™ | ç”Ÿæˆå | è§£é‡Š |
|------|------------------|--------|------|
| `\s` | `\\s` | `\s` | æ¨¡æ¿è½¬ä¹‰ 1 æ¬¡ |
| `\\s` | `\\\\s` | `\\s` | æ¨¡æ¿è½¬ä¹‰ 1 æ¬¡ |
| `\\\s` | `\\\\\\s` | `\\s` | å­—ç¬¦ä¸²å†…å®¹ä¸º `\\s` |

### ä¸ºä»€ä¹ˆä½¿ç”¨ RegExp æ„é€ å‡½æ•°ï¼Ÿ

```javascript
// âŒ å±é™©ï¼šæ­£åˆ™å­—é¢é‡
/^\\\\/?\/stigmergy-resume\s*/i
//        â†‘ ä¸å‘½ä»¤åä¸­çš„ / å†²çª

// âœ… å®‰å…¨ï¼šRegExp æ„é€ å‡½æ•°
new RegExp('^\\\\\\\\/?' + '/stigmergy-resume' + '\\\\\s*', 'i')
//           â†‘ é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥é¿å… / å†²çª
```

### ç»éªŒæ•™è®­

#### 1. æ°¸è¿œè®°ä½çš„è§„åˆ™

> **åœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­ç”ŸæˆåŒ…å«æ­£åˆ™çš„ä»£ç æ—¶ï¼Œä½¿ç”¨ RegExp æ„é€ å‡½æ•° + å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæ°¸è¿œæ¯”å°è¯•è®¡ç®—æ­£ç¡®çš„æ­£åˆ™å­—é¢é‡è½¬ä¹‰æ›´å®‰å…¨ï¼**

```javascript
// âœ… å®‰å…¨ã€æ¸…æ™°ã€å¯ç»´æŠ¤
new RegExp('pattern' + variable + 'pattern', 'flags')

// âŒ å±é™©ã€å¤æ‚ã€æ˜“å‡ºé”™
/pattern${variable}pattern/flags
```

#### 2. å¿…é¡»éµå®ˆçš„è§„åˆ™

- [ ] **æ°¸è¿œä¸è¦é˜»æ­¢æ’å€¼**ï¼šä½¿ç”¨ `${variable}`ï¼Œè€Œä¸æ˜¯ `\${variable}`
- [ ] **åŠ¨æ€æ¨¡å¼ â†’ RegExp æ„é€ å‡½æ•°**ï¼šé¿å…æ­£åˆ™å­—é¢é‡ä¸­çš„ `/` å†²çª
- [ ] **åæ–œæ æ•°é‡å¿…é¡»è®¡ç®—**ï¼šä½¿ç”¨å…¬å¼ï¼Œä¸èƒ½çŒœæµ‹
- [ ] **å¿…é¡»æ·»åŠ è¯­æ³•éªŒè¯**ï¼šç”Ÿæˆä»£ç åç«‹å³æµ‹è¯•è¯­æ³•
- [ ] **å¿…é¡»æ³¨é‡Šè¯´æ˜è½¬ä¹‰**ï¼šè®©å…¶ä»–äººç†è§£ä½ çš„è®¡ç®—

#### 3. ä»£ç å®¡æŸ¥æ£€æŸ¥æ¸…å•

æ¶‰åŠ **æ¨¡æ¿å­—ç¬¦ä¸² + æ­£åˆ™è¡¨è¾¾å¼** çš„ä»£ç å¿…é¡»æ£€æŸ¥ï¼š

```javascript
// âœ… æ£€æŸ¥é¡¹
- [ ] æ‰€æœ‰ ${variable} æ˜¯å¦çœŸçš„éœ€è¦æ’å€¼ï¼ˆä¸æ˜¯ \${variable}ï¼‰
- [ ] å¦‚æœæ¨¡å¼åŒ…å«åŠ¨æ€çš„ /ï¼Œæ˜¯å¦ä½¿ç”¨äº† RegExp æ„é€ å‡½æ•°
- [ ] åæ–œæ æ•°é‡æ˜¯å¦ç»è¿‡è®¡ç®—ï¼ˆè€ŒéçŒœæµ‹ï¼‰
- [ ] æ˜¯å¦æœ‰è¯­æ³•éªŒè¯æµ‹è¯•
- [ ] æ˜¯å¦æ³¨é‡Šè¯´æ˜äº†è½¬ä¹‰çš„è®¡ç®—è¿‡ç¨‹
```

### éªŒè¯å·¥å…·

```javascript
/**
 * éªŒè¯ç”Ÿæˆçš„ä»£ç æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
 */
function validateGeneratedCode(code) {
  try {
    new Function(code);
    return true;
  } catch (e) {
    console.error('âŒ è¯­æ³•é”™è¯¯:', e.message);
    console.error('ä»£ç :', code);
    return false;
  }
}

/**
 * è®¡ç®—éœ€è¦çš„åæ–œæ æ•°é‡
 */
function calculateBackslashes(targetCount, nestingDepth = 1) {
  return '\\'.repeat(targetCount * Math.pow(2, nestingDepth));
}

// ä½¿ç”¨ç¤ºä¾‹
const generatedCode = generator.generateForCLI('claude');
if (!validateGeneratedCode(generatedCode)) {
  throw new Error('ç”Ÿæˆçš„ä»£ç æœ‰è¯­æ³•é”™è¯¯ï¼');
}
```

### ç›¸å…³æ–‡æ¡£

- [å¼€å‘è§„èŒƒ - ä»£ç ç”Ÿæˆè§„èŒƒ](./development_guidelines.md#10-ä»£ç ç”Ÿæˆè§„èŒƒ)
- [ResumeSessionGenerator æºä»£ç ](../src/core/coordination/nodejs/generators/ResumeSessionGenerator.js)
- [ä¿®å¤æäº¤](https://github.com/your-repo/commit/6a2ee2c6)

---

## ğŸ“‹ é”™è¯¯æ•™è®­å¿«é€Ÿå‚è€ƒ

### æ­£åˆ™è¡¨è¾¾å¼ç”Ÿæˆ

| åœºæ™¯ | âœ… æ­£ç¡® | âŒ é”™è¯¯ |
|------|--------|--------|
| åŠ¨æ€æ¨¡å¼ | `new RegExp(pattern + var)` | `/pattern${var}/` |
| æ¨¡æ¿æ’å€¼ | `${variable}` | `\${variable}` |
| åæ–œæ è½¬ä¹‰ | é€šè¿‡å…¬å¼è®¡ç®— | çŒœæµ‹æ•°é‡ |
| è¯­æ³•éªŒè¯ | å¿…é¡»æ·»åŠ  | è·³è¿‡æµ‹è¯• |

### è½¬ä¹‰é€ŸæŸ¥è¡¨

| ç”Ÿæˆç›®æ ‡ | æ¨¡æ¿å­—ç¬¦ä¸²ä¸­å†™ | è¯´æ˜ |
|----------|----------------|------|
| `\s` | `\\s` | åŒ¹é…ç©ºç™½å­—ç¬¦ |
| `\\s` | `\\\\s` | å­—ç¬¦ä¸² `"\s"` |
| `\\\s` | `\\\\\\s` | å­—ç¬¦ä¸² `"\\s"` |
| `/stigmergy-resume` | `${commandName}` | æ’å€¼å‘½ä»¤å |
| `RegExp('/stigmergy-resume')` | `new RegExp('${commandName}')` | åŠ¨æ€æ­£åˆ™ |

---

## ğŸ”„ å¦‚ä½•æ·»åŠ æ–°çš„é”™è¯¯æ•™è®­

å½“é‡åˆ°é‡å¤§é”™è¯¯æ—¶ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è®°å½•ï¼š

```markdown
## ğŸ”´ è‡´å‘½é”™è¯¯ #N: [é”™è¯¯æ ‡é¢˜]

**æ—¥æœŸ**: YYYY-MM-DD
**å½±å“**: [å½±å“èŒƒå›´]
**ä¿®å¤ç‰ˆæœ¬**: vX.X.X
**è°ƒè¯•æ—¶é—´**: çº¦ X å°æ—¶
**å¤±è´¥å°è¯•**: X æ¬¡

### é—®é¢˜æè¿°
[æè¿°é—®é¢˜çš„ç°è±¡å’Œé”™è¯¯ä¿¡æ¯]

### é”™è¯¯ä»£ç 
**æ–‡ä»¶**: [æ–‡ä»¶è·¯å¾„]
**ä½ç½®**: Line XXX

```javascript
// âŒ é”™è¯¯å†™æ³•
[é”™è¯¯ä»£ç ]
```

### æ ¹æœ¬åŸå› åˆ†æ
[åˆ†æä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯]

### æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ
```javascript
// âœ… æ­£ç¡®å†™æ³•
[æ­£ç¡®ä»£ç ]
```

### ç»éªŒæ•™è®­
[æ€»ç»“è§„åˆ™å’Œæ£€æŸ¥æ¸…å•]

### éªŒè¯å·¥å…·
[æä¾›éªŒè¯å’Œæµ‹è¯•æ–¹æ³•]
```

---

**æœ€åæ›´æ–°**: 2025-12-25
**ç»´æŠ¤è€…**: Stigmergy å¼€å‘å›¢é˜Ÿ

**è®°ä½è¿™äº›æ•™è®­ï¼Œé¿å…é‡å¤çŠ¯é”™ï¼**
