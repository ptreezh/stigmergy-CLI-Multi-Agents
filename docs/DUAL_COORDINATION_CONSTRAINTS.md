# 双重协调层和持续协同系统 - 约束和验证规则

## 1. 开发约束

### 1.1 技术约束

#### TC-1: 语言和框架
- **约束**: 必须使用 TypeScript 编写所有新代码
- **验证**: 所有 `.ts` 文件必须通过 TypeScript 编译器检查
- **工具**: `tsc --noEmit`
- **理由**: TypeScript 提供类型安全，减少运行时错误

#### TC-2: Node.js 版本
- **约束**: 必须支持 Node.js 18+ 版本
- **验证**: 在 CI/CD 中测试 Node.js 18、20、22 版本
- **工具**: `nvm` 或 `n` 进行版本测试
- **理由**: 确保兼容性和性能

#### TC-3: Python 版本（可选）
- **约束**: 如果使用 Python，必须支持 Python 3.8+
- **验证**: 检测 Python 版本，低于 3.8 时警告
- **工具**: `python --version`
- **理由**: 确保功能完整性和安全性

#### TC-4: 依赖管理
- **约束**: 所有依赖必须在 `package.json` 中声明
- **验证**: 运行 `npm audit` 检查安全漏洞
- **工具**: `npm audit`, `npm outdated`
- **理由**: 确保依赖安全和可维护

### 1.2 架构约束

#### AC-1: 模块化设计
- **约束**: 每个模块必须单一职责
- **验证**: 每个模块文件不超过 500 行
- **工具**: ESLint 规则 `max-lines-per-file`
- **理由**: 提高代码可读性和可维护性

#### AC-2: 接口一致性
- **约束**: Node.js 和 Python 协调层必须实现相同接口
- **验证**: 接口契约测试
- **工具**: Jest 接口测试套件
- **理由**: 确保特性对等和可替换性

#### AC-3: 依赖方向
- **约束**: 高层模块不能依赖低层模块
- **验证**: 依赖图分析
- **工具**: `madge` 或 `dependency-cruiser`
- **理由**: 避免循环依赖，提高系统稳定性

#### AC-4: 错误处理
- **约束**: 所有异步操作必须有错误处理
- **验证**: TypeScript 严格模式，`noImplicitAny`
- **工具**: TypeScript 编译器
- **理由**: 提高系统健壮性

### 1.3 性能约束

#### PC-1: 启动时间
- **约束**: 系统启动时间 < 2 秒
- **验证**: 性能基准测试
- **工具**: `benchmark.js` 或 `clinic.js`
- **理由**: 提供良好的用户体验

#### PC-2: 内存占用
- **约束**: 正常操作内存占用 < 100MB
- **验证**: 内存泄漏检测
- **工具**: `heapdump`, `clinic.js`
- **理由**: 避免资源耗尽

#### PC-3: 响应时间
- **约束**: 协调层选择响应时间 < 100ms
- **约束**: 任务执行响应时间 < 500ms
- **验证**: 性能监控
- **工具**: `performance.now()`, APM 工具
- **理由**: 确保系统响应性

#### PC-4: 并发处理
- **约束**: 支持至少 10 个并发任务
- **验证**: 压力测试
- **工具**: `k6`, `artillery`
- **理由**: 支持高并发场景

### 1.4 安全约束

#### SC-1: 输入验证
- **约束**: 所有外部输入必须验证
- **验证**: 单元测试覆盖所有验证逻辑
- **工具**: Jest, `joi` 或 `zod`
- **理由**: 防止注入攻击

#### SC-2: 进程隔离
- **约束**: Python 协调层必须运行在独立进程
- **验证**: 进程隔离测试
- **工具**: 进程监控工具
- **理由**: 提高系统稳定性

#### SC-3: 数据加密
- **约束**: 敏感数据必须加密存储
- **验证**: 加密算法测试
- **工具**: `crypto` 模块
- **理由**: 保护用户数据

#### SC-4: 访问控制
- **约束**: CLI 工具必须有访问控制
- **验证**: 权限测试
- **工具**: 访问控制测试套件
- **理由**: 防止未授权访问

## 2. 验证规则

### 2.1 代码质量验证

#### VQ-1: 代码覆盖率
- **规则**: 单元测试覆盖率 >= 80%
- **规则**: 集成测试覆盖率 >= 70%
- **验证**: `jest --coverage`
- **阈值**: `coverageThreshold` in jest.config.js

#### VQ-2: 代码风格
- **规则**: 所有代码必须符合 ESLint 规则
- **规则**: 所有代码必须符合 Prettier 格式
- **验证**: `npm run lint`, `npm run format`
- **工具**: ESLint, Prettier

#### VQ-3: 代码复杂度
- **规则**: 圈复杂度 < 10
- **规则**: 认知复杂度 < 15
- **验证**: `eslint-plugin-complexity`
- **工具**: ESLint 复杂度插件

#### VQ-4: 代码重复
- **规则**: 重复代码率 < 5%
- **验证**: `jscpd` 或 `sonarqube`
- **工具**: `jscpd`, SonarQube

### 2.2 功能验证

#### VF-1: Python 检测准确性
- **规则**: Python 检测准确率 >= 95%
- **验证**: 多环境测试
- **测试**: Windows, Linux, macOS, 有 Python, 无 Python

#### VF-2: 协调层切换
- **规则**: 协调层切换必须无缝
- **验证**: 切换测试
- **测试**: 正常切换、降级切换、恢复切换

#### VF-3: 特性对等性
- **规则**: Node.js 和 Python 协调层功能完全对等
- **验证**: 特性对比测试
- **工具**: 自动化特性对比工具

#### VF-4: 优雅降级
- **规则**: 降级切换必须不影响用户使用
- **验证**: 降级场景测试
- **测试**: Node.js 崩溃、Python 崩溃、网络故障

### 2.3 性能验证

#### VP-1: 启动性能
- **规则**: 冷启动时间 < 2 秒
- **规则**: 热启动时间 < 1 秒
- **验证**: 启动时间测试
- **工具**: `time` 命令, `benchmark.js`

#### VP-2: 内存性能
- **规则**: 空闲内存 < 50MB
- **规则**: 峰值内存 < 150MB
- **验证**: 内存监控
- **工具**: `heapdump`, `clinic.js`

#### VP-3: 响应性能
- **规则**: P50 响应时间 < 200ms
- **规则**: P95 响应时间 < 500ms
- **规则**: P99 响应时间 < 1000ms
- **验证**: 性能基准测试
- **工具**: APM 工具

#### VP-4: 吞吐量
- **规则**: 支持 >= 100 tasks/min
- **验证**: 压力测试
- **工具**: `k6`, `artillery`

### 2.4 兼容性验证

#### VC-1: 平台兼容性
- **规则**: 支持 Windows 10/11
- **规则**: 支持 Linux (Ubuntu 20.04+, CentOS 7+)
- **规则**: 支持 macOS 11+
- **验证**: 多平台测试
- **工具**: CI/CD 多平台构建

#### VC-2: CLI 工具兼容性
- **规则**: 支持 Claude CLI
- **规则**: 支持 Qwen CLI
- **规则**: 支持 iFlow CLI
- **规则**: 支持 Codex CLI
- **规则**: 支持 CodeBuddy CLI
- **规则**: 支持 QoderCLI CLI
- **验证**: CLI 工具集成测试
- **工具**: 集成测试套件

#### VC-3: Node.js 版本兼容性
- **规则**: 支持 Node.js 18.x
- **规则**: 支持 Node.js 20.x
- **规则**: 支持 Node.js 22.x
- **验证**: 多版本测试
- **工具**: `nvm`, CI/CD 矩阵构建

#### VC-4: 向后兼容性
- **规则**: 不破坏现有 API
- **规则**: 不破坏现有配置
- **验证**: 回归测试
- **工具**: 现有测试套件

### 2.5 可靠性验证

#### VR-1: 可用性
- **规则**: 系统可用性 >= 99.5%
- **验证**: 可用性监控
- **工具**: APM 工具, 监控系统

#### VR-2: 容错性
- **规则**: 单点故障不影响系统
- **验证**: 故障注入测试
- **工具**: Chaos Engineering

#### VR-3: 恢复时间
- **规则**: MTTR < 1 分钟
- **验证**: 恢复测试
- **工具**: 故障恢复测试套件

#### VR-4: 数据一致性
- **规则**: 状态同步无冲突
- **验证**: 一致性测试
- **工具**: 数据一致性检查工具

## 3. 开发规范

### 3.1 代码编写规范

#### CS-1: 命名约定
- **规则**: 类名使用 PascalCase
- **规则**: 函数名使用 camelCase
- **规则**: 常量使用 UPPER_SNAKE_CASE
- **规则**: 接口使用 PascalCase + I 前缀
- **验证**: ESLint `@typescript-eslint/naming-convention`

#### CS-2: 注释规范
- **规则**: 公共 API 必须有 JSDoc 注释
- **规则**: 复杂逻辑必须有行内注释
- **规则**: TODO/FIXME 必须有任务编号
- **验证**: `eslint-plugin-jsdoc`

#### CS-3: 错误处理
- **规则**: 使用 `try-catch` 处理所有异步错误
- **规则**: 错误必须包含上下文信息
- **规则**: 错误必须记录日志
- **验证**: ESLint `no-unsafe-finally`

#### CS-4: 异步编程
- **规则**: 使用 `async/await` 而不是回调
- **规则**: 使用 `Promise.all` 并行执行
- **规则**: 避免嵌套 Promise
- **验证**: ESLint `no-callback-literal`, `prefer-promise-reject-errors`

### 3.2 测试编写规范

#### TS-1: 测试结构
- **规则**: 使用 `describe` 组织测试套件
- **规则**: 使用 `it` 描述测试用例
- **规则**: 测试名称必须清晰描述测试内容
- **验证**: Jest 测试结构检查

#### TS-2: 测试覆盖率
- **规则**: 每个函数至少有一个测试用例
- **规则**: 每个分支至少有一个测试用例
- **规则**: 边界条件必须有测试用例
- **验证**: Jest 覆盖率报告

#### TS-3: 测试独立性
- **规则**: 测试之间必须独立
- **规则**: 测试不能依赖执行顺序
- **规则**: 测试后必须清理状态
- **验证**: 随机执行顺序测试

#### TS-4: 测试数据
- **规则**: 使用工厂函数创建测试数据
- **规则**: 测试数据必须隔离
- **规则**: 敏感数据必须使用 Mock
- **验证**: 测试数据隔离检查

### 3.3 文档编写规范

#### DS-1: API 文档
- **规则**: 所有公共 API 必须有文档
- **规则**: 文档必须包含参数说明
- **规则**: 文档必须包含返回值说明
- **规则**: 文档必须包含示例
- **验证**: `typedoc` 或 `api-extractor`

#### DS-2: 代码注释
- **规则**: 复杂算法必须有注释
- **规则**: 业务逻辑必须有注释
- **规则**: 临时解决方案必须有 TODO
- **验证**: ESLint `jsdoc/require-jsdoc`

#### DS-3: 变更日志
- **规则**: 所有变更必须记录在 CHANGELOG.md
- **规则**: 变更必须包含版本号
- **规则**: 变更必须包含日期
- **规则**: 变更必须包含作者
- **验证**: CHANGELOG.md 检查工具

#### DS-4: README
- **规则**: 每个模块必须有 README
- **规则**: README 必须包含安装说明
- **规则**: README 必须包含使用示例
- **规则**: README 必须包含贡献指南
- **验证**: README 模板检查

## 4. CI/CD 约束

### 4.1 构建约束

#### B-1: 构建成功
- **约束**: 所有构建必须成功
- **验证**: CI/CD 构建检查
- **工具**: GitHub Actions, GitLab CI

#### B-2: 构建时间
- **约束**: 构建时间 < 10 分钟
- **验证**: 构建时间监控
- **工具**: CI/CD 构建日志

#### B-3: 构建产物
- **约束**: 构建产物必须包含所有必要文件
- **验证**: 构建产物清单检查
- **工具**: 构建产物验证脚本

#### B-4: 构建缓存
- **约束**: 使用构建缓存加速构建
- **验证**: 缓存命中率监控
- **工具**: CI/CD 缓存机制

### 4.2 测试约束

#### T-1: 测试通过
- **约束**: 所有测试必须通过
- **验证**: CI/CD 测试检查
- **工具**: Jest, Mocha

#### T-2: 测试覆盖率
- **约束**: 测试覆盖率必须达标
- **验证**: 覆盖率报告检查
- **工具**: Jest 覆盖率报告

#### T-3: 测试性能
- **约束**: 测试执行时间 < 5 分钟
- **验证**: 测试性能监控
- **工具**: Jest 性能报告

#### T-4: 测试隔离
- **约束**: 测试必须隔离执行
- **验证**: 测试隔离检查
- **工具**: Jest 隔离配置

### 4.3 部署约束

#### D-1: 部署成功
- **约束**: 所有部署必须成功
- **验证**: 部署状态检查
- **工具**: CI/CD 部署日志

#### D-2: 部署回滚
- **约束**: 部署失败时必须自动回滚
- **验证**: 回滚机制测试
- **工具**: CI/CD 回滚配置

#### D-3: 部署验证
- **约束**: 部署后必须运行验证测试
- **验证**: 部署验证测试
- **工具**: 部署验证脚本

#### D-4: 部署通知
- **约束**: 部署结果必须通知团队
- **验证**: 通知机制测试
- **工具**: Slack, Email 通知

## 5. 安全约束

### 5.1 代码安全

#### SEC-1: 依赖安全
- **约束**: 所有依赖必须无已知漏洞
- **验证**: `npm audit` 检查
- **工具**: `npm audit`, `snyk`

#### SEC-2: 代码扫描
- **约束**: 代码必须通过安全扫描
- **验证**: 静态代码分析
- **工具**: `sonarqube`, `eslint-plugin-security`

#### SEC-3: 密钥管理
- **约束**: 密钥不能硬编码在代码中
- **验证**: 密钥扫描
- **工具**: `git-secrets`, `truffleHog`

#### SEC-4: 输入清理
- **约束**: 所有用户输入必须清理
- **验证**: 输入清理测试
- **工具**: `validator.js`, `joi`

### 5.2 运行时安全

#### RS-1: 进程隔离
- **约束**: Python 进程必须隔离
- **验证**: 进程隔离测试
- **工具**: 进程监控工具

#### RS-2: 资源限制
- **约束**: 进程资源必须有限制
- **验证**: 资源限制测试
- **工具**: `ulimit`, `cgroups`

#### RS-3: 日志安全
- **约束**: 敏感信息不能记录在日志中
- **验证**: 日志安全检查
- **工具**: 日志扫描工具

#### RS-4: 错误处理
- **约束**: 错误信息不能泄露敏感信息
- **验证**: 错误处理测试
- **工具**: 错误处理测试套件

## 6. 监控约束

### 6.1 性能监控

#### PM-1: 响应时间监控
- **约束**: 必须监控响应时间
- **验证**: 监控数据检查
- **工具**: APM 工具, Prometheus

#### PM-2: 吞吐量监控
- **约束**: 必须监控吞吐量
- **验证**: 监控数据检查
- **工具**: APM 工具, Grafana

#### PM-3: 错误率监控
- **约束**: 必须监控错误率
- **验证**: 监控数据检查
- **工具**: APM 工具, Sentry

#### PM-4: 资源使用监控
- **约束**: 必须监控 CPU、内存、磁盘使用
- **验证**: 监控数据检查
- **工具**: `top`, `htop`, `vmstat`

### 6.2 告警约束

#### A-1: 告警阈值
- **约束**: 响应时间 > 1 秒时告警
- **约束**: 错误率 > 5% 时告警
- **约束**: 内存使用 > 80% 时告警
- **验证**: 告警规则测试
- **工具**: Prometheus AlertManager

#### A-2: 告警通知
- **约束**: 关键告警必须立即通知
- **验证**: 告警通知测试
- **工具**: PagerDuty, Slack

#### A-3: 告警升级
- **约束**: 告警未处理时必须升级
- **验证**: 告警升级测试
- **工具**: 告警升级策略

#### A-4: 告警抑制
- **约束**: 重复告警必须抑制
- **验证**: 告警抑制测试
- **工具**: 告警抑制规则

## 7. 维护约束

### 7.1 代码维护

#### CM-1: 代码审查
- **约束**: 所有代码必须经过审查
- **验证**: 代码审查记录
- **工具**: GitHub Pull Request

#### CM-2: 重构规则
- **约束**: 重构必须保持测试通过
- **验证**: 重构测试
- **工具**: 重构测试套件

#### CM-3: 技术债务
- **约束**: 技术债务必须有记录
- **验证**: 技术债务跟踪
- **工具**: SonarQube, Jira

#### CM-4: 依赖更新
- **约束**: 依赖必须定期更新
- **验证**: 依赖更新检查
- **工具**: `npm outdated`, `Dependabot`

### 7.2 文档维护

#### DM-1: 文档更新
- **约束**: 代码变更时必须更新文档
- **验证**: 文档同步检查
- **工具**: 文档同步工具

#### DM-2: 文档审查
- **约束**: 重要文档必须经过审查
- **验证**: 文档审查记录
- **工具**: GitHub Pull Request

#### DM-3: 文档版本
- **约束**: 文档必须有版本号
- **验证**: 文档版本检查
- **工具**: 文档版本管理

#### DM-4: 文档归档
- **约束**: 过期文档必须归档
- **验证**: 文档归档检查
- **工具**: 文档归档工具

## 8. 合规约束

### 8.1 开源合规

#### OS-1: 许可证
- **约束**: 所有依赖必须有兼容的许可证
- **验证**: 许可证检查
- **工具**: `license-checker`, `FOSSA`

#### OS-2: 版权声明
- **约束**: 所有代码必须有版权声明
- **验证**: 版权声明检查
- **工具**: 版权检查工具

#### OS-3: 第三方代码
- **约束**: 第三方代码必须声明来源
- **验证**: 第三方代码检查
- **工具**: `license-checker`

#### OS-4: 贡献者协议
- **约束**: 所有贡献者必须签署 CLA
- **验证**: CLA 签署检查
- **工具**: CLA 检查工具

### 8.2 隐私合规

#### PR-1: 数据保护
- **约束**: 用户数据必须保护
- **验证**: 数据保护检查
- **工具**: 数据保护审计

#### PR-2: 日志记录
- **约束**: 敏感数据不能记录在日志中
- **验证**: 日志隐私检查
- **工具**: 日志扫描工具

#### PR-3: 数据删除
- **约束**: 用户数据必须支持删除
- **验证**: 数据删除测试
- **工具**: 数据删除测试套件

#### PR-4: 数据导出
- **约束**: 用户数据必须支持导出
- **验证**: 数据导出测试
- **工具**: 数据导出测试套件

## 9. 质量保证

### 9.1 代码质量指标

#### QM-1: 圈复杂度
- **指标**: 平均圈复杂度 < 10
- **验证**: `eslint-plugin-complexity`
- **工具**: ESLint

#### QM-2: 代码重复率
- **指标**: 重复代码率 < 5%
- **验证**: `jscpd`
- **工具**: `jscpd`, SonarQube

#### QM-3: 代码覆盖率
- **指标**: 单元测试覆盖率 >= 80%
- **指标**: 集成测试覆盖率 >= 70%
- **验证**: Jest 覆盖率报告
- **工具**: Jest

#### QM-4: 缺陷密度
- **指标**: 缺陷密度 < 5/KLOC
- **验证**: 缺陷跟踪系统
- **工具**: Jira, Bugzilla

### 9.2 性能质量指标

#### QP-1: 启动时间
- **指标**: 启动时间 < 2 秒
- **验证**: 性能基准测试
- **工具**: `benchmark.js`

#### QP-2: 响应时间
- **指标**: P50 响应时间 < 200ms
- **指标**: P95 响应时间 < 500ms
- **指标**: P99 响应时间 < 1000ms
- **验证**: 性能监控
- **工具**: APM 工具

#### QP-3: 吞吐量
- **指标**: 吞吐量 >= 100 tasks/min
- **验证**: 压力测试
- **工具**: `k6`, `artillery`

#### QP-4: 资源使用
- **指标**: CPU 使用率 < 80%
- **指标**: 内存使用率 < 80%
- **验证**: 资源监控
- **工具**: `top`, `htop`

### 9.3 可靠性质量指标

#### QR-1: 可用性
- **指标**: 可用性 >= 99.5%
- **验证**: 可用性监控
- **工具**: APM 工具

#### QR-2: MTBF
- **指标**: MTBF > 24 小时
- **验证**: 故障统计
- **工具**: 故障跟踪系统

#### QR-3: MTTR
- **指标**: MTTR < 1 分钟
- **验证**: 恢复时间统计
- **工具**: 故障跟踪系统

#### QR-4: 错误率
- **指标**: 错误率 < 1%
- **验证**: 错误监控
- **工具**: APM 工具, Sentry

## 10. 工具和配置

### 10.1 必需工具

| 工具 | 用途 | 版本 |
|------|------|------|
| Node.js | 运行环境 | 18+ |
| npm | 包管理 | 9+ |
| TypeScript | 类型检查 | 5+ |
| Jest | 测试框架 | 29+ |
| ESLint | 代码检查 | 8+ |
| Prettier | 代码格式化 | 3+ |
| Git | 版本控制 | 2+ |

### 10.2 推荐工具

| 工具 | 用途 | 版本 |
|------|------|------|
| SonarQube | 代码质量分析 | 9+ |
| Jest | 测试覆盖率 | 29+ |
| k6 | 性能测试 | 0.47+ |
| Artillery | 负载测试 | 2+ |
| Prometheus | 监控 | 2.45+ |
| Grafana | 可视化 | 9+ |
| Sentry | 错误跟踪 | 7+ |

### 10.3 配置文件

#### package.json
```json
{
  "scripts": {
    "build": "tsc",
    "test": "jest",
    "test:unit": "jest tests/unit",
    "test:integration": "jest tests/integration",
    "test:e2e": "jest tests/e2e",
    "test:coverage": "jest --coverage",
    "lint": "eslint src/**/*.ts",
    "format": "prettier --write src/**/*.ts",
    "audit": "npm audit",
    "audit:fix": "npm audit fix"
  }
}
```

#### tsconfig.json
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true
  }
}
```

#### jest.config.js
```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70
    }
  }
};
```

## 11. 实施检查清单

### 11.1 开发前检查

- [ ] 环境配置完成
- [ ] 依赖安装完成
- [ ] IDE 配置完成
- [ ] Git 仓库配置完成
- [ ] CI/CD 配置完成

### 11.2 开发中检查

- [ ] 代码符合规范
- [ ] 测试覆盖率达标
- [ ] 性能指标达标
- [ ] 安全检查通过
- [ ] 文档更新完成

### 11.3 开发后检查

- [ ] 所有测试通过
- [ ] 代码审查通过
- [ ] 文档审查通过
- [ ] 部署验证通过
- [ ] 用户验收通过

## 12. 违规处理

### 12.1 轻微违规

- **处理**: 代码审查时指出
- **修复**: 3 天内修复
- **跟踪**: 任务跟踪系统

### 12.2 严重违规

- **处理**: 阻止合并
- **修复**: 立即修复
- **跟踪**: 紧急任务

### 12.3 关键违规

- **处理**: 紧急修复
- **修复**: 24 小时内修复
- **跟踪**: 高优先级任务

## 13. 持续改进

### 13.1 规则更新

- **频率**: 每季度审查
- **流程**: 团队讨论
- **批准**: 架构师批准

### 13.2 工具更新

- **频率**: 每月审查
- **流程**: 评估工具效果
- **批准**: 团队批准

### 13.3 流程优化

- **频率**: 每季度优化
- **流程**: 分析瓶颈
- **批准**: 团队批准

---

**文档版本**: 1.0.0  
**创建日期**: 2026-01-15  
**作者**: Stigmergy Team  
**状态**: 草稿