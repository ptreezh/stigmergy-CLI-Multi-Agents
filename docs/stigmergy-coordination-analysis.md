# Stigmergy 协同机制分析

## 当前实现的问题

### 1. 缺乏真正的协同
- ❌ 所有CLI执行相同的任务（重复工作）
- ❌ 没有结果聚合和选择机制
- ❌ 没有冲突检测和解决
- ❌ 没有工作分配策略

### 2. 可能的干扰场景
- 🔄 多个CLI同时修改同一文件
- 🔄 生成重复的代码或解决方案
- 🔄 覆盖彼此的修改
- 🔄 资源竞争（锁、临时文件）

## Stigmergy 间接协同原理

### 核心概念
Stigmergy 是一种通过**环境**进行间接通信的协同机制：

```
CLI A → 修改环境 → CLI B → 读取环境 → CLI C → 继续修改
   ↓                      ↓                      ↓
留下痕迹               感知痕迹              新的痕迹
```

### 类比：蚂蚁协同
- 🐜 蚂蚁A留下信息素 → 蚂蚁B感知信息素 → 蚂蚁B加强信息素
- 🐜 通过环境（信息素）间接协同，无需直接通信
- 🐜 正反馈：越多的蚂蚁走同一路径，信息素越强

## 实现方案

### 1. 环境状态管理

```javascript
class StigmergyEnvironment {
  // 工作空间状态
  workspaceState = {
    files: {},           // 文件修改历史
    tasks: {},           // 任务分配状态
    results: {},         // 结果缓存
    conflicts: []        // 冲突记录
  }

  // CLI留下的"痕迹"
  traces = {
    fileModifications: [],   // 文件修改记录
    generatedCode: [],       // 生成的代码
    testResults: [],         // 测试结果
    dependencies: []         // 依赖关系
  }
}
```

### 2. 协同策略

#### 策略A: 任务分解 + 分配
```
大任务 → 分解子任务 → 根据CLI特长分配 → 聚合结果
```

#### 策略B: 竞争 + 投票
```
所有CLI执行相同任务 → 比较结果 → 投票选择最佳
```

#### 策略C: 渐进式增强
```
CLI A生成基础版本 → CLI B改进 → CLI C优化 → 最终结果
```

#### 策略D: 互补工作
```
CLI A写测试 → CLI B写代码 → CLI C写文档 → 完整方案
```

### 3. 冲突避免机制

```javascript
// 文件锁机制
class FileLockManager {
  acquireLock(filePath, cliName) {
    // 检查文件是否被锁定
    // 获取锁，设置超时
  }

  releaseLock(filePath, cliName) {
    // 释放锁
  }

  detectConflicts() {
    // 检测潜在冲突
  }
}
```

### 4. 结果聚合

```javascript
class ResultAggregator {
  aggregate(results) {
    // 策略1: 投票机制
    // 策略2: 质量评分
    // 策略3: 混合合并
    // 策略4: 专家权重
  }
}
```

## 实现架构

```
┌─────────────────────────────────────────────────┐
│          Stigmergy Coordination Layer          │
├─────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐           │
│  │ Task Planner │  │ Work Allocator│           │
│  └──────────────┘  └──────────────┘           │
│  ┌──────────────┐  ┌──────────────┐           │
│  │Conflict Mgr  │  │Result Aggr.  │           │
│  └──────────────┘  └──────────────┘           │
│  ┌──────────────────────────────────────────┐  │
│  │     Stigmergy Environment (State)       │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│              CLI Agents Layer                   │
├─────────────┬─────────────┬─────────────┬───────┤
│    Qwen     │   iFlow     │   Claude    │  ...  │
└─────────────┴─────────────┴─────────────┴───────┘
```

## 下一步实现

1. ✅ 创建 StigmergyEnvironment 类
2. ✅ 实现文件锁机制
3. ✅ 实现任务分解器
4. ✅ 实现结果聚合器
5. ✅ 更新 CentralOrchestrator 集成协同层
