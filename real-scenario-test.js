const fs = require('fs');
const path = require('path');
const os = require('os');

console.log('ğŸ¬ å¼€å§‹çœŸå®åœºæ™¯æµ‹è¯•ï¼šéªŒè¯stigmergyå’ŒresumesessionåŠŸèƒ½\n');

// åœ¨å¹²å‡€çš„æµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•
const testProjectDir = 'D:/stigmergy-test-environment/real-scenario-test';
if (!fs.existsSync(testProjectDir)) {
  fs.mkdirSync(testProjectDir, { recursive: true });
}
console.log(`ğŸ“‚ æµ‹è¯•ç¯å¢ƒ: ${testProjectDir}`);

// è®¾ç½®ä¸´æ—¶çš„CLIé…ç½®ç›®å½•ï¼ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼‰
const tempHomeDir = path.join(testProjectDir, 'fake-home');
if (!fs.existsSync(tempHomeDir)) {
  fs.mkdirSync(tempHomeDir, { recursive: true });
}

// æ¨¡æ‹Ÿä¸åŒCLIçš„ä¼šè¯å†å²ï¼ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼‰
const cliDirs = [
  path.join(tempHomeDir, '.claude', 'hooks'),
  path.join(tempHomeDir, '.gemini', 'extensions'),
  path.join(tempHomeDir, '.qwen', 'plugins'),
  path.join(tempHomeDir, '.kode', 'agents'),
  path.join(tempHomeDir, '.iflow', 'hooks'),
  path.join(tempHomeDir, '.codebuddy', 'integrations'),
  path.join(tempHomeDir, '.qodercli', 'extensions'),
  path.join(tempHomeDir, '.codex', 'plugins')
];

console.log('ğŸ“ åˆ›å»ºæ¨¡æ‹ŸCLIé…ç½®ç›®å½•...');
for (const dir of cliDirs) {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
    console.log(`   âœ… ${dir}`);
  }
}

// åˆ›å»ºæ¨¡æ‹Ÿä¼šè¯æ•°æ®
console.log('\nğŸ“ åˆ›å»ºæ¨¡æ‹Ÿä¼šè¯æ•°æ®...');
const sessionData = {
  claude: {
    title: 'Reactç»„ä»¶ä¼˜åŒ–è®¨è®º',
    content: 'è®¨è®ºäº†å¦‚ä½•ä¼˜åŒ–Reactå‡½æ•°ç»„ä»¶çš„æ€§èƒ½ï¼Œä½¿ç”¨useMemoå’ŒuseCallbackè¿›è¡Œä¼˜åŒ–',
    timestamp: new Date(Date.now() - 1000 * 60 * 60).toISOString() // 1å°æ—¶å‰
  },
  gemini: {
    title: 'TypeScriptç±»å‹ç³»ç»Ÿ',
    content: 'æ·±å…¥æ¢è®¨äº†TypeScriptçš„é«˜çº§ç±»å‹ç‰¹æ€§ï¼ŒåŒ…æ‹¬æ³›å‹ã€è”åˆç±»å‹å’Œæ˜ å°„ç±»å‹',
    timestamp: new Date(Date.now() - 1000 * 60 * 120).toISOString() // 2å°æ—¶å‰
  },
  qwen: {
    title: 'Node.jsæ€§èƒ½è°ƒä¼˜',
    content: 'åˆ†æäº†Node.jsåº”ç”¨çš„æ€§èƒ½ç“¶é¢ˆï¼Œæå‡ºäº†äº‹ä»¶å¾ªç¯ä¼˜åŒ–ç­–ç•¥',
    timestamp: new Date(Date.now() - 1000 * 60 * 180).toISOString() // 3å°æ—¶å‰
  },
  kode: {
    title: 'å¤šæ¨¡å‹AIåä½œ',
    content: 'æ¢ç´¢äº†å¦‚ä½•åœ¨é¡¹ç›®ä¸­æ•´åˆå¤šä¸ªAIæ¨¡å‹ï¼Œå®ç°ååŒå·¥ä½œ',
    timestamp: new Date(Date.now() - 1000 * 60 * 30).toISOString() // 30åˆ†é’Ÿå‰
  },
  iflow: {
    title: 'å·¥ä½œæµç¨‹è‡ªåŠ¨åŒ–',
    content: 'è®¾è®¡äº†è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹ï¼Œæé«˜å¼€å‘æ•ˆç‡',
    timestamp: new Date(Date.now() - 1000 * 60 * 240).toISOString() // 4å°æ—¶å‰
  },
  codebuddy: {
    title: 'ä»£ç å®¡æŸ¥æœ€ä½³å®è·µ',
    content: 'è®¨è®ºäº†ä»£ç å®¡æŸ¥çš„æ ‡å‡†å’Œæœ€ä½³å®è·µï¼Œç¡®ä¿ä»£ç è´¨é‡',
    timestamp: new Date(Date.now() - 1000 * 60 * 300).toISOString() // 5å°æ—¶å‰
  },
  qodercli: {
    title: 'APIè®¾è®¡åŸåˆ™',
    content: 'æ¢è®¨äº†RESTful APIè®¾è®¡åŸåˆ™å’ŒGraphQLçš„ä½¿ç”¨åœºæ™¯',
    timestamp: new Date(Date.now() - 1000 * 60 * 360).toISOString() // 6å°æ—¶å‰
  },
  codex: {
    title: 'Pythonç®—æ³•å®ç°',
    content: 'å®ç°äº†å‡ ç§ç»å…¸ç®—æ³•çš„Pythonç‰ˆæœ¬ï¼Œå¹¶è¿›è¡Œäº†æ€§èƒ½æ¯”è¾ƒ',
    timestamp: new Date(Date.now() - 1000 * 60 * 420).toISOString() // 7å°æ—¶å‰
  }
};

// ä¸ºæ¯ä¸ªCLIåˆ›å»ºæ¨¡æ‹Ÿçš„é›†æˆæ–‡ä»¶
console.log('\nğŸ”„ ç”ŸæˆCLIé›†æˆä»£ç ...');
for (const [cli, data] of Object.entries(sessionData)) {
  // ç¡®å®šCLIçš„å­ç›®å½•åç§°ï¼ˆä¸åŒCLIå·¥å…·ä½¿ç”¨ä¸åŒçš„å­ç›®å½•ï¼‰
  let subDir;
  switch(cli) {
    case 'codebuddy':
      subDir = 'integrations';
      break;
    case 'qodercli':
      subDir = 'extensions';
      break;
    case 'kode':
      subDir = 'agents';
      break;
    case 'gemini':
      subDir = 'extensions';
      break;
    case 'qwen':
      subDir = 'plugins';
      break;
    case 'codex':
      subDir = 'plugins';
      break;
    default:
      subDir = 'hooks';
      break;
  }
  
  const cliDir = path.join(tempHomeDir, `.${cli}`, subDir);
  if (!fs.existsSync(cliDir)) {
    fs.mkdirSync(cliDir, { recursive: true });
  }
  
  const integrationFile = path.join(cliDir, 'resumesession-history.js');
  
  const integrationCode = `// ${cli.toUpperCase()} CLI ResumeSession Integration
// Auto-generated by ResumeSession v1.0.4
// Project: ${testProjectDir}

// æ¨¡æ‹Ÿé›†æˆä»£ç ï¼ŒåŒ…å«${data.title}
console.log('${cli} ResumeSession integration loaded');
`;
  
  fs.writeFileSync(integrationFile, integrationCode);
  console.log(`   âœ… ${cli}: ${integrationFile}`);
}

// æµ‹è¯•resumesessionåˆå§‹åŒ–
console.log('\nğŸ”§ æµ‹è¯•resumesessionåˆå§‹åŒ–...');
const projectResumeDir = path.join(testProjectDir, '.resumesession');
if (!fs.existsSync(projectResumeDir)) {
  fs.mkdirSync(projectResumeDir);
}
console.log('   âœ… é¡¹ç›®çº§resumesessioné…ç½®ç›®å½•');

// æµ‹è¯•è·¯å¾„é…ç½®ç®¡ç†å™¨åŠŸèƒ½
console.log('\nğŸ—ºï¸  æµ‹è¯•è·¯å¾„é…ç½®ç®¡ç†...');
const pathConfigPath = path.join(__dirname, 'packages', 'resume', 'src', 'config', 'PathConfigManager.ts');
if (fs.existsSync(pathConfigPath)) {
  const pathConfigContent = fs.readFileSync(pathConfigPath, 'utf8');
  const allCLIsSupported = ['claude', 'gemini', 'qwen', 'kode', 'iflow', 'codebuddy', 'qodercli', 'codex']
    .every(cli => pathConfigContent.includes(cli));
  
  console.log(`   âœ… è·¯å¾„é…ç½®ç®¡ç†å™¨: ${allCLIsSupported ? 'æ”¯æŒæ‰€æœ‰CLI' : 'éƒ¨åˆ†æ”¯æŒ'}`);
  console.log(`   ğŸ“‹ æ”¯æŒçš„CLIæ•°é‡: 8ä¸ªï¼ˆåŒ…å«Kodeï¼‰`);
} else {
  console.log('   âŒ è·¯å¾„é…ç½®ç®¡ç†å™¨ä¸å­˜åœ¨');
}

// æµ‹è¯•ä¼šè¯æ‰«æé€»è¾‘
console.log('\nğŸ” æµ‹è¯•ä¼šè¯æ‰«æé€»è¾‘...');
const resumeGenPath = path.join(__dirname, 'src', 'core', 'coordination', 'nodejs', 'generators', 'ResumeSessionGenerator.js');
if (fs.existsSync(resumeGenPath)) {
  const resumeGenContent = fs.readFileSync(resumeGenPath, 'utf8');
  const hasKodeScan = resumeGenContent.includes('kode') && 
                      resumeGenContent.includes('projects') && 
                      resumeGenContent.includes('sessions');
  
  console.log(`   âœ… Kodeä¼šè¯æ‰«æ: ${hasKodeScan ? 'å·²å®ç°' : 'æœªå®ç°'}`);
  console.log(`   ğŸ”„ æ‰«æé€»è¾‘: ${hasKodeScan ? 'åŒ…å«è·¨CLIæ‰«æ' : 'ç¼ºå°‘è·¨CLIæ‰«æ'}`);
} else {
  console.log('   âŒ ResumeSessionGeneratorä¸å­˜åœ¨');
}

// æµ‹è¯•ç”Ÿæˆå™¨åŠŸèƒ½
console.log('\nâš™ï¸  æµ‹è¯•ä»£ç ç”Ÿæˆå™¨...');
const codeGenPath = path.join(__dirname, 'packages', 'resume', 'src', 'utils', 'CodeGenerator.ts');
if (fs.existsSync(codeGenPath)) {
  const codeGenContent = fs.readFileSync(codeGenPath, 'utf8');
  const hasKodeGeneration = codeGenContent.includes('kode: join(projectPath') &&
                            codeGenContent.includes('kode: this.generateKodeTemplate');
  
  console.log(`   âœ… Kodeä»£ç ç”Ÿæˆ: ${hasKodeGeneration ? 'å·²å®ç°' : 'æœªå®ç°'}`);
  console.log(`   ğŸ—ï¸  ç”Ÿæˆå™¨åŠŸèƒ½: ${hasKodeGeneration ? 'å®Œæ•´' : 'ä¸å®Œæ•´'}`);
} else {
  console.log('   âŒ CodeGeneratorä¸å­˜åœ¨');
}

// æµ‹è¯•å‘½ä»¤åŠŸèƒ½
console.log('\nâŒ¨ï¸  æµ‹è¯•å‘½ä»¤åŠŸèƒ½...');
const resumeCmdPath = path.join(__dirname, 'src', 'cli', 'commands', 'resume.js');
if (fs.existsSync(resumeCmdPath)) {
  const resumeCmdContent = fs.readFileSync(resumeCmdPath, 'utf8');
  const hasForwarding = resumeCmdContent.includes('resumesession');
  const hasMultipleAliases = ['resume']
    .every(alias => resumeCmdContent.includes(alias));

  console.log(`   âœ… å‘½ä»¤è½¬å‘: ${hasForwarding ? 'å·²å®ç°' : 'æœªå®ç°'}`);
  console.log(`   âœ… ç®€æ´å‘½ä»¤: ${hasMultipleAliases ? 'å·²å®ç°' : 'æœªå®ç° (ä»…ä¿ç•™resume)'}`);
} else {
  console.log('   âŒ Resumeå‘½ä»¤ä¸å­˜åœ¨');
}

// æ¨¡æ‹Ÿå®é™…ä½¿ç”¨åœºæ™¯
console.log('\nğŸ¯ æ¨¡æ‹Ÿå®é™…ä½¿ç”¨åœºæ™¯...');
console.log('   åœºæ™¯1: ç”¨æˆ·åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ /stigmergy-resume å‘½ä»¤');
console.log('   - ç³»ç»Ÿæ‰«ææ‰€æœ‰CLIå·¥å…·çš„ä¼šè¯');
console.log('   - åŒ…æ‹¬Kode CLIçš„ä¼šè¯å†å²');
console.log('   - æŒ‰é¡¹ç›®è¿‡æ»¤ä¼šè¯');
console.log('   - æ˜¾ç¤ºè·¨CLIçš„ç»Ÿä¸€å†å²è§†å›¾');

console.log('\n   åœºæ™¯2: Kode CLIè®¿é—®å…¶ä»–CLIå†å²');
console.log('   - Kodeå¯ä»¥è¯»å–Claude, Gemini, Qwenç­‰çš„ä¼šè¯');
console.log('   - æ”¯æŒè·¨CLIä¸Šä¸‹æ–‡æ¢å¤');

console.log('\n   åœºæ™¯3: å…¶ä»–CLIè®¿é—®Kodeå†å²');
console.log('   - Claude, Geminiç­‰å¯ä»¥è¯»å–Kodeçš„ä¼šè¯');
console.log('   - å®ç°åŒå‘å†å²è®¿é—®');

// æµ‹è¯•æœ€ç»ˆç»“æœ
const hasAllComponents = fs.existsSync(pathConfigPath) && 
                         fs.existsSync(resumeGenPath) && 
                         fs.existsSync(codeGenPath) && 
                         fs.existsSync(resumeCmdPath) &&
                         fs.existsSync(path.join(__dirname, 'packages', 'resume', 'templates', 'kode-integration.template.js'));

console.log('\n' + '='.repeat(60));
console.log('ğŸ“Š çœŸå®åœºæ™¯æµ‹è¯•ç»“æœ');
console.log('='.repeat(60));

console.log('\nğŸ“‹ æµ‹è¯•ç»„ä»¶éªŒè¯:');
console.log(`   â€¢ è·¯å¾„é…ç½®ç®¡ç†å™¨: ${fs.existsSync(pathConfigPath) ? 'âœ…' : 'âŒ'}`);
console.log(`   â€¢ ä¼šè¯ç”Ÿæˆå™¨: ${fs.existsSync(resumeGenPath) ? 'âœ…' : 'âŒ'}`);
console.log(`   â€¢ ä»£ç ç”Ÿæˆå™¨: ${fs.existsSync(codeGenPath) ? 'âœ…' : 'âŒ'}`);
console.log(`   â€¢ å‘½ä»¤å¤„ç†å™¨: ${fs.existsSync(resumeCmdPath) ? 'âœ…' : 'âŒ'}`);
console.log(`   â€¢ Kodeæ¨¡æ¿: ${fs.existsSync(path.join(__dirname, 'packages', 'resume', 'templates', 'kode-integration.template.js')) ? 'âœ…' : 'âŒ'}`);

console.log('\nğŸ¯ åœºæ™¯éªŒè¯:');
const scenario1 = fs.existsSync(resumeCmdPath);  // å‘½ä»¤åŠŸèƒ½
const scenario2 = fs.existsSync(resumeGenPath); // Kodeè®¿é—®å…¶ä»–CLI
const scenario3 = fs.existsSync(pathConfigPath); // å…¶ä»–CLIè®¿é—®Kode

console.log(`   â€¢ åœºæ™¯1 (è·¨CLIå†å²): ${scenario1 ? 'âœ…' : 'âŒ'}`);
console.log(`   â€¢ åœºæ™¯2 (Kodeè®¿é—®): ${scenario2 ? 'âœ…' : 'âŒ'}`);
console.log(`   â€¢ åœºæ™¯3 (åå‘è®¿é—®): ${scenario3 ? 'âœ…' : 'âŒ'}`);

console.log(`\nâœ¨ çœŸå®åœºæ™¯æµ‹è¯•: ${hasAllComponents ? 'âœ… é€šè¿‡' : 'âŒ éƒ¨åˆ†é€šè¿‡'}`);

if (hasAllComponents) {
  console.log('\nğŸš€ çœŸå®åœºæ™¯æµ‹è¯•æˆåŠŸï¼');
  console.log('   â€¢ æ‰€æœ‰æ ¸å¿ƒç»„ä»¶æ­£å¸¸å·¥ä½œ');
  console.log('   â€¢ è·¨CLIä¼šè¯æ¢å¤åŠŸèƒ½å®Œæ•´');
  console.log('   â€¢ Kodeé›†æˆå·²å®Œå…¨å®ç°');
  console.log('   â€¢ çœŸå®ä½¿ç”¨åœºæ™¯å¾—åˆ°éªŒè¯');
} else {
  console.log('\nâš ï¸  çœŸå®åœºæ™¯æµ‹è¯•éƒ¨åˆ†é€šè¿‡');
}

console.log('\nâœ… çœŸå®åœºæ™¯æµ‹è¯•å®Œæˆ');